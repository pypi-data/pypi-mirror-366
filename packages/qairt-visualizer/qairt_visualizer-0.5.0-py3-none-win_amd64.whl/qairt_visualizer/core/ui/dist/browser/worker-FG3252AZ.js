var L=6;var g=12,R=g+L*2;var A="--qds-node-category-uncategorized",l={DATA:"Data",NN_LAYER:"NN Layer",ACTIVATION:"Activation",POOLING:"Pooling",NORMALIZATION:"Normalization",MATH:"Math",SHAPE:"Shape",TRANSFORM:"Transform",QUANTIZATION:"Quantization",SYNTHETIC_LAYER:"Synthetic Layer",NAMESPACE_LAYER:"Namespace Layer",DEFAULT:"Default"},b={[l.DATA]:"--qds-node-category-data",[l.NN_LAYER]:"--qds-node-category-layer",[l.ACTIVATION]:"--qds-node-category-activation",[l.POOLING]:"--qds-node-category-pool",[l.NORMALIZATION]:"--qds-node-category-normalization",[l.MATH]:"--qds-node-category-math",[l.SHAPE]:"--qds-node-category-shape",[l.TRANSFORM]:"--qds-node-category-transform",[l.QUANTIZATION]:"--qds-node-category-quantization",[l.SYNTHETIC_LAYER]:"--qds-artificial-layer-header-1",[l.NAMESPACE_LAYER]:"--qds-layer-header-1",[l.DEFAULT]:A},V={[l.NN_LAYER]:["conv","deconv","fc","dense","linear","lstm","gru","rnn","attention","transformer","embedding"],[l.ACTIVATION]:["relu","sigmoid","tanh","softmax","gelu","swish","elu","selu","activation"],[l.POOLING]:["pool","maxpool","avgpool"],[l.NORMALIZATION]:["norm","batchnorm","layernorm","groupnorm","instancenorm","rmsnorm","lrn"],[l.MATH]:["add","sub","mul","div","mod","pow","neg","abs","sin","cos","tan","asin","acos","atan","sinh","cosh","tanh","exp","log","sqrt","reciprocal","erf","sum","mean","max","min","reducesum","reducemean","reducemax","reducemin","reduceprod","reducel1","reducel2","reducelogsum","reducelogsumexp","reducesumsquare","equal","greater","less","greaterorequal","lessorequal","and","or","xor","not","floor","ceil","round","clip","sign","matmul","bitwiseand","bitwiseor","bitwisexor","bitwisenot","cumsum"],[l.SHAPE]:["reshape","shape","size","flatten"],[l.TRANSFORM]:["transpose","gather","slice","concat","split","cast","pad","tile","repeat","flip","squeeze","unsqueeze","expand"],[l.QUANTIZATION]:["quant","dequant","quantize","dequantize"]};function p(e){return e.children?.length>0}var m=1e3;function E(e){e.hierarchyRoot=v(e),e.layerDescendantsMap=M(e.hierarchyRoot),e.ancestorMap=$(e.hierarchyRoot)}function v(e){let t=C(e);return j(t,e.nodeMap),S(t,e),O(t,0),D(t,e.adjacencyList,e.nodeMap),t}function C(e){let t={id:"root",parent:void 0,name:"root",namespace:"root",inputs:[],outputs:[],children:[],edges:[],depth:0};e.nodeMap.root=t;for(let o of e.nodes){let n="root",r=o.namespace.split("/");for(let i=0;i<r.length;i++){let c=r.slice(0,i+1).join("/"),s=c.split("/").pop(),a=e.nodeMap[n];if(!e.nodeMap[c]){let u={id:c,parent:a,name:s,namespace:c,inputs:[],outputs:[],children:[],edges:[],depth:a.depth+1};e.nodeMap[c]=u,a.children.push(u)}n=c}o.parent=e.nodeMap[n],o.parent.children.push(o)}return t}function S(e,t){let o=[e];for(;o.length>0;){let n=o.pop();n.children.length>m&&H(n,t.adjacencyList,t);for(let r=n.children.length-1;r>=0;r--){let i=n.children[r];p(i)&&o.push(i)}}}function H(e,t,o){let{layerAdjacencyList:n,inverseLayerAdjacencyList:r}=_(e,t,o.nodeMap),i,c=q(e.children,r,o.nodeMap);if(c.length===e.children.length)i=T(c,m);else{console.warn(`Topological sort failed to visit all nodes in layer "${e.name}", likely due to a cycle. Falling back to BFS`);let a=G(e.children,n,r,o.nodeMap);i=T(a,m)}let s=[];for(let a=0;a<i.length;a++){let u=`${e.namespace}/section-${a+1}`,d={id:u,parent:e,name:`Synthetic ${a+1} of ${i.length}`,namespace:u,children:i[a],inputs:[],outputs:[],edges:[],depth:e.depth+1,isArtificial:!0};s.push(d),o.nodeMap[d.id]=d}e.children=s,x(e)}function q(e,t,o){let n={};e.forEach(s=>n[s.id]=0);for(let s of Object.values(t))for(let a of Object.keys(s))n[a]++;let r=[],c=e.filter(s=>n[s.id]===0).map(s=>s.id);for(;c.length>0;){let s=c.shift();r.push(o[s]);for(let a of Object.keys(t[s]||{}))n[a]--,n[a]===0&&c.push(a)}return r}function G(e,t,o,n){let r=[],i=new Set,s=e.filter(a=>!t[a.id]).map(a=>a.id);for(;s.length>0;){let a=s.shift();if(!i.has(a)){i.add(a),r.push(n[a]);for(let u of Object.keys(o[a]||{}))i.has(u)||s.push(u)}}return r}function T(e,t){let o=[];for(let n=e.length;n>0;n-=t){let r=Math.max(0,n-t);o.push(e.slice(r,n))}return o}function x(e){for(let t of e.children)t.parent=e,t.namespace=`${e.namespace}/${t.namespace.split("/").pop()}`,p(t)&&x(t)}function j(e,t){function o(n,r){if(p(n))if(n.children.length===1){let i=n.children[0],c=r.children.findIndex(s=>s.id===n.id);if(c!==-1){let s=r.children[c];delete t[s.id],r.children[c]=i,i.parent=r}o(i,r)}else for(let i of n.children)o(i,n)}for(let n of e.children)o(n,e)}function O(e,t){if(p(e)){e.depth=t;for(let o of e.children)O(o,t+1)}}function D(e,t,o){e.edges=P(e,t,o);for(let n of e.children)p(n)&&D(n,t,o)}function P(e,t,o){let{layerAdjacencyList:n}=_(e,t,o),r=[];for(let i in n)for(let c in n[i]){let s=o[i],a=o[c];r.push(Y(s,a,n[i][c].tensor))}return r}function _(e,t,o){let n=M(e),r={},i={},c={},s=[];for(let d of e.children)c[d.id]=d,p(d)&&s.push(d);function a(d,f,I){let h=o[f];N(r,d,h,I),N(i,h,d,I)}function u(d,f){for(let I of s){if(I===d)continue;if(n[I.id].has(f)){let y;p(d)||(y=t[d.id][f].tensor),N(r,d,I,y),N(i,I,d,y);break}}}for(let d of e.children)if(p(d)){let f=n[d.id];for(let I of f)for(let h of Object.keys(t[I]||{}))if(c[h]){let y=t[I][h].tensor;a(d,h,y)}else u(d,h)}else for(let f of Object.keys(t[d.id]||{}))if(c[f]){let I=t[d.id][f].tensor;a(d,f,I)}else u(d,f);return{layerAdjacencyList:r,inverseLayerAdjacencyList:i}}function N(e,t,o,n){e[t.id]||(e[t.id]={}),e[t.id][o.id]={tensor:n}}function M(e){let t={};function o(n){let r=new Set;for(let i of n.children)p(i)?o(i).forEach(s=>r.add(s)):r.add(i.id);return t[n.id]=r,r}return o(e),t}function Y(e,t,o){let n=o?o.name:`inter-layer-edge--${e.id}->${t.id}`;return{id:`${e.id}->${t.id}`,edgeGroupId:n,sourceNode:e,targetNode:t,tensor:o}}function $(e){let t={};function o(n,r){if(t[n.id]=r,p(n))for(let i of n.children)o(i,[...r,n])}for(let n of e.children)o(n,[]);return t}function w(e){let{data:t}=e.data;E(t),postMessage({graph:t})}addEventListener("message",w);export{w as messageHandler};
