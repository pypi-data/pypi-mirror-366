from attr import define
from twisted.internet.defer import Deferred


@define
class When:
    """
    An observerable event that can by async-ly listened for and
    triggered exactly once.

    Generally useful to implement the "when_something()" pattern in
    Twisted
    """

    _awaiters: list = []
    _result: object = None

    def when_triggered(self):
        """
        :return Awaitable: a new Deferred that fires when this observable
            has fired (which may have already happened).
        """
        d = Deferred()
        if self._awaiters is None:
            d.callback(self._result)
        else:
            self._awaiters.append(d)
        return d

    def trigger(self, result):
        """
        Called at most once, with the result for this observable
        """
        print(f"{self}: trigger: {result}")
        assert self._awaiters is not None, "Observable triggered twice"
        self._result = result
        listeners, self._awaiters = self._awaiters, None
        for d in listeners:
            d.callback(result)
