---
title: Technology Stack
description: "定义项目的技术栈、架构模式和开发工具链。"
inclusion: always
---

# 技术栈

## 核心技术

### 编程语言
- **Python 3.12+**: 项目基础语言，使用最新特性
- **类型提示**: 全面使用 Python 类型提示，提升代码质量

### 核心依赖
- **Redis 6.0+**: 消息存储和队列管理后端
  - `redis[hiredis]>=6.0.0`: Python Redis 客户端，包含高性能 hiredis 解析器
- **Pydantic 2.0+**: 数据验证和序列化
  - 使用 V2 API (`model_validate`, `model_dump` 等)
  - 提供类型安全的消息结构定义

### 开发工具链

#### 包管理
- **uv**: 现代 Python 包管理器（推荐）
- **pyproject.toml**: 项目配置和依赖管理

#### 代码质量
- **pytest>=7.0.0**: 单元测试框架
- **pytest-asyncio>=0.21.0**: 异步测试支持
- **pytest-cov>=4.0.0**: 测试覆盖率
- **black>=23.0.0**: 代码格式化
- **ruff>=0.1.0**: 快速 linting 工具
- **mypy>=1.5.0**: 静态类型检查

#### 文档工具
- **sphinx>=7.0.0**: 文档生成
- **sphinx-rtd-theme>=1.3.0**: 文档主题

#### 可选日志后端
- **loguru>=0.7.0**: 现代日志库（可选）
- **structlog>=23.1.0**: 结构化日志（可选）

## 架构模式

### 设计模式
- **组合模式**: 替代 Mixin，提升代码可维护性
- **依赖注入**: 通过 QueueContext 传递依赖
- **门面模式**: 日志系统支持多种后端
- **策略模式**: 可插拔的消息处理策略

### 架构原则
- **垂直切片架构**: 按功能模块组织代码，而非技术分层
- **单一职责**: 每个模块只负责一个明确功能
- **早期返回**: 使用卫语句减少代码嵌套
- **原子操作**: 基于 Lua 脚本保证 Redis 操作原子性

## 核心模块架构

### 主要组件
```
src/mx_rmq/
├── core/                 # 核心业务逻辑
│   ├── context.py       # 队列上下文管理
│   ├── consumer.py      # 消费者服务
│   ├── dispatch.py      # 消息分发服务
│   ├── lifecycle.py     # 消息生命周期管理
│   └── schedule.py      # 调度服务（延时任务、监控）
├── storage/             # 存储层抽象
├── monitoring/          # 监控和指标收集
├── logging/             # 日志系统
├── resources/           # Lua 脚本资源
├── config.py           # 配置管理
├── message.py          # 消息模型定义
├── queue.py            # 主要队列接口
└── constants.py        # 常量定义
```

### 异步架构
- **asyncio**: 基于 Python 原生异步框架
- **协程池**: 分发协程池处理并发消息
- **非阻塞 I/O**: 高并发消息处理能力

## 数据存储

### Redis 数据结构
- **Hash**: 消息内容存储 (`payload_map`)
- **ZSet**: 延时任务调度 (`delay_tasks`)
- **ZSet**: 过期消息监控 (`expire_monitor`)
- **List**: 队列消息存储 (按优先级分层)
- **Set**: 处理中消息跟踪 (`processing`)

### Lua 脚本
- 保证 Redis 操作的原子性
- 减少网络往返次数
- 实现复杂的队列操作逻辑

## 性能特性

### 高性能设计
- **内存存储**: 基于 Redis 内存数据库
- **批量处理**: 延时任务和过期消息批量处理
- **连接池**: Redis 连接复用
- **异步处理**: 非阻塞消息处理

### 可靠性保证
- **原子操作**: Lua 脚本保证操作原子性
- **消息持久化**: Redis 持久化机制
- **重试机制**: 指数退避重试策略
- **死信队列**: 失败消息隔离处理

## 部署要求

### 运行环境
- **Python**: 3.12 或更高版本
- **Redis**: 6.0 或更高版本
- **内存**: 建议 512MB+ 可用内存
- **网络**: Redis 客户端网络连接

### 容器化支持
- **Docker**: 支持容器化部署
- **docker-compose**: 提供完整的开发环境配置

## 测试策略

### 测试类型
- **单元测试**: 模块级功能测试
- **集成测试**: Redis 集成测试
- **异步测试**: asyncio 异步代码测试
- **覆盖率测试**: 代码覆盖率监控

### 测试工具
- **pytest**: 主要测试框架
- **pytest-asyncio**: 异步测试支持
- **pytest-cov**: 覆盖率报告
- **conftest.py**: 测试配置和 fixtures

## 构建和发布

### 构建工具
- **hatchling**: 现代 Python 构建后端
- **build**: 包构建工具
- **twine**: PyPI 发布工具

### CI/CD
- 自动化测试流水线
- 代码质量检查
- 自动化发布到 PyPI