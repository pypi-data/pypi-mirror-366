# æ™ºèƒ½é¢‘ç‡é™åˆ¶ç®¡ç†å™¨

## æ¦‚è¿°

ä¸ºäº†è§£å†³ Binance API é¢‘ç‡é™åˆ¶é—®é¢˜ï¼Œæˆ‘ä»¬å®ç°äº†ä¸€ä¸ªæ™ºèƒ½çš„é¢‘ç‡é™åˆ¶ç®¡ç†å™¨ (`RateLimitManager`)ï¼Œèƒ½å¤Ÿè‡ªåŠ¨æ£€æµ‹ã€å¤„ç†å’Œè§„é¿ API é¢‘ç‡é™åˆ¶ï¼Œç¡®ä¿æ•°æ®ä¸‹è½½çš„ç¨³å®šæ€§å’Œå®Œæ•´æ€§ã€‚

## ä¸»è¦ç‰¹æ€§

### ğŸ¯ æ™ºèƒ½é¢‘ç‡æ§åˆ¶
- **åŠ¨æ€å»¶è¿Ÿè°ƒæ•´**: æ ¹æ® API å“åº”è‡ªåŠ¨è°ƒæ•´è¯·æ±‚é—´éš”
- **é¢„é˜²æ€§é™åˆ¶**: åœ¨æ¥è¿‘é¢‘ç‡é™åˆ¶å‰ä¸»åŠ¨å‡é€Ÿ
- **é”™è¯¯æ¢å¤**: é‡åˆ°é¢‘ç‡é™åˆ¶é”™è¯¯æ—¶è‡ªåŠ¨æ¢å¤

### ğŸ“Š å®æ—¶ç›‘æ§
- **è¯·æ±‚è®¡æ•°**: è·Ÿè¸ªæ¯åˆ†é’Ÿçš„è¯·æ±‚æ•°é‡
- **é”™è¯¯ç»Ÿè®¡**: è®°å½•è¿ç»­é”™è¯¯æ¬¡æ•°
- **å»¶è¿Ÿä¼˜åŒ–**: åœ¨æ— é”™è¯¯æ—¶é€æ¸é™ä½å»¶è¿Ÿ

### ğŸ”„ è‡ªé€‚åº”ç­–ç•¥
- **æ¸è¿›å¼é€€é¿**: é”™è¯¯æ¬¡æ•°è¶Šå¤šï¼Œå»¶è¿Ÿæ—¶é—´è¶Šé•¿
- **æ™ºèƒ½é‡ç½®**: æˆåŠŸè¯·æ±‚åé€æ­¥æ¢å¤æ­£å¸¸é€Ÿåº¦
- **çº¿ç¨‹å®‰å…¨**: æ”¯æŒå¤šçº¿ç¨‹å¹¶å‘è®¿é—®

## å·¥ä½œåŸç†

### 1. é¢„é˜²æœºåˆ¶
```python
# ç›‘æ§æ¯åˆ†é’Ÿè¯·æ±‚æ•°
if requests_this_minute >= max_requests_per_minute * 0.8:
    # è¾¾åˆ°80%é™åˆ¶æ—¶å¢åŠ å»¶è¿Ÿ
    additional_delay = 2.0
```

### 2. é”™è¯¯å¤„ç†
```python
# é‡åˆ°é¢‘ç‡é™åˆ¶é”™è¯¯æ—¶
if is_rate_limit_error(error):
    wait_time = rate_limit_manager.handle_rate_limit_error()
    time.sleep(wait_time)
    # è‡ªåŠ¨é‡è¯•
```

### 3. åŠ¨æ€è°ƒæ•´
```python
# æ ¹æ®é”™è¯¯æ¬¡æ•°è°ƒæ•´å»¶è¿Ÿ
if consecutive_errors <= 3:
    current_delay *= 2    # ç­‰å¾…1åˆ†é’Ÿ
elif consecutive_errors <= 6:
    current_delay *= 1.5  # ç­‰å¾…2åˆ†é’Ÿ
else:
    current_delay = 20.0  # ç­‰å¾…5åˆ†é’Ÿ
```

## ä½¿ç”¨æ–¹æ³•

### åŸºæœ¬ä½¿ç”¨
```python
from cryptoservice.services.market_service import MarketDataService

service = MarketDataService(api_key="your_key", api_secret="your_secret")

# ä½¿ç”¨æ™ºèƒ½é¢‘ç‡æ§åˆ¶ä¸‹è½½æ•°æ®
service.get_perpetual_data(
    symbols=["BTCUSDT", "ETHUSDT"],
    start_time="2024-10-01",
    end_time="2024-10-31",
    db_path="./data/market.db",
    request_delay=2.0,  # åŸºç¡€å»¶è¿Ÿ2ç§’
)
```

### ä¿å®ˆæ¨¡å¼ï¼ˆæ¨èï¼‰
```python
# ç”¨äºå¤§æ‰¹é‡ä¸‹è½½çš„ä¿å®ˆè®¾ç½®
service.download_universe_data(
    universe_file="./data/universe.json",
    db_path="./data/market.db",
    max_workers=1,        # å•çº¿ç¨‹
    request_delay=3.0,    # è¾ƒé•¿çš„åŸºç¡€å»¶è¿Ÿ
    max_retries=5,        # æ›´å¤šé‡è¯•æ¬¡æ•°
)
```

## é…ç½®å‚æ•°

### RateLimitManager å‚æ•°
| å‚æ•° | é»˜è®¤å€¼ | è¯´æ˜ |
|------|-------|------|
| `base_delay` | 0.5ç§’ | åŸºç¡€è¯·æ±‚é—´éš” |
| `max_requests_per_minute` | 1800 | æ¯åˆ†é’Ÿæœ€å¤§è¯·æ±‚æ•°ï¼ˆä¿å®ˆä¼°è®¡ï¼‰ |

### åŠ¨æ€è°ƒæ•´ç­–ç•¥
| é”™è¯¯æ¬¡æ•° | å»¶è¿Ÿå€æ•° | ç­‰å¾…æ—¶é—´ | è¯´æ˜ |
|----------|----------|----------|------|
| 1-3æ¬¡ | 2å€ | 60ç§’ | è½»åº¦é™åˆ¶ |
| 4-6æ¬¡ | 1.5å€ | 120ç§’ | ä¸­åº¦é™åˆ¶ |
| 7+æ¬¡ | å›ºå®š20ç§’ | 300ç§’ | ä¸¥é‡é™åˆ¶ |

## ç›‘æ§å’Œè°ƒè¯•

### æ—¥å¿—ä¿¡æ¯
```
âš ï¸ æ¥è¿‘é¢‘ç‡é™åˆ¶ï¼Œå¢åŠ å»¶è¿Ÿ: 2.0ç§’
ğŸš« é¢‘ç‡é™åˆ¶é”™è¯¯ #1ï¼Œç­‰å¾… 60ç§’ï¼Œè°ƒæ•´å»¶è¿Ÿè‡³ 4.0ç§’
âœ… æ¢å¤æ­£å¸¸ï¼Œå½“å‰å»¶è¿Ÿ: 2.0ç§’
```

### è°ƒè¯•æ¨¡å¼
```python
import logging
logging.getLogger('cryptoservice').setLevel(logging.DEBUG)
```

## æœ€ä½³å®è·µ

### 1. é€‰æ‹©åˆé€‚çš„åŸºç¡€å»¶è¿Ÿ
- **å°æ‰¹é‡ä¸‹è½½**: 1-2ç§’
- **ä¸­ç­‰æ‰¹é‡**: 2-3ç§’
- **å¤§æ‰¹é‡ä¸‹è½½**: 3-5ç§’

### 2. å¹¶å‘æ§åˆ¶
- **æµ‹è¯•ç¯å¢ƒ**: max_workers=1
- **ç”Ÿäº§ç¯å¢ƒ**: max_workers=1-2ï¼ˆè°¨æ…ä½¿ç”¨ï¼‰

### 3. é”™è¯¯å¤„ç†
```python
try:
    service.download_universe_data(...)
except KeyboardInterrupt:
    print("ç”¨æˆ·ä¸­æ–­ï¼Œå·²ä¸‹è½½çš„æ•°æ®å·²ä¿å­˜")
except Exception as e:
    print(f"ä¸‹è½½é”™è¯¯: {e}")
    print("å¯ä»¥é‡æ–°è¿è¡Œç»§ç»­ä¸‹è½½")
```

## æ•…éšœæ’é™¤

### å¸¸è§é—®é¢˜

1. **ä»ç„¶é‡åˆ°é¢‘ç‡é™åˆ¶**
   - å¢åŠ  `request_delay` åˆ° 5-10ç§’
   - è®¾ç½® `max_workers=1`
   - æ£€æŸ¥æ˜¯å¦æœ‰å…¶ä»–ç¨‹åºåœ¨ä½¿ç”¨åŒä¸€ API

2. **ä¸‹è½½é€Ÿåº¦å¤ªæ…¢**
   - åœ¨ä½å³°æœŸä¸‹è½½
   - é€æ­¥å‡å°‘ `request_delay`
   - æ£€æŸ¥ç½‘ç»œè¿æ¥ç¨³å®šæ€§

3. **æ•°æ®ä¸å®Œæ•´**
   - å¢åŠ  `max_retries` æ•°é‡
   - ä½¿ç”¨æ›´é•¿çš„åŸºç¡€å»¶è¿Ÿ
   - æ£€æŸ¥ API å¯†é’¥æƒé™

### æ€§èƒ½å¯¹æ¯”

| æ¨¡å¼ | æˆåŠŸç‡ | ä¸‹è½½é€Ÿåº¦ | é€‚ç”¨åœºæ™¯ |
|------|--------|----------|----------|
| æ— é™åˆ¶ | 30-50% | å¾ˆå¿« | ä¸æ¨è |
| å›ºå®šå»¶è¿Ÿ | 70-80% | ä¸­ç­‰ | å°æ‰¹é‡ |
| æ™ºèƒ½ç®¡ç† | 95%+ | ç¨³å®š | æ¨è |

## æŠ€æœ¯å®ç°

### çº¿ç¨‹å®‰å…¨
ä½¿ç”¨ `threading.Lock()` ç¡®ä¿å¤šçº¿ç¨‹ç¯å¢ƒä¸‹çš„æ•°æ®ä¸€è‡´æ€§ã€‚

### çŠ¶æ€ç®¡ç†
- `request_count`: å½“å‰çª—å£å†…è¯·æ±‚æ•°
- `consecutive_errors`: è¿ç»­é”™è¯¯æ¬¡æ•°
- `current_delay`: å½“å‰å»¶è¿Ÿæ—¶é—´

### è‡ªåŠ¨æ¢å¤
æˆåŠŸè¯·æ±‚åè‡ªåŠ¨å‡å°‘é”™è¯¯è®¡æ•°ï¼Œé€æ­¥æ¢å¤æ­£å¸¸é€Ÿåº¦ã€‚

## æ›´æ–°æ—¥å¿—

- **v1.0**: åŸºç¡€é¢‘ç‡é™åˆ¶ç®¡ç†
- **v1.1**: æ·»åŠ æ™ºèƒ½é¢„é˜²æœºåˆ¶
- **v1.2**: ä¼˜åŒ–é”™è¯¯æ¢å¤ç­–ç•¥
- **v1.3**: æ·»åŠ å¤šçº¿ç¨‹æ”¯æŒ
