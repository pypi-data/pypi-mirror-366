# è¯·æ±‚é—´éš”åŠŸèƒ½è¯´æ˜

## æ¦‚è¿°

ä¸ºäº†é¿å…è§¦å‘ Binance API çš„é¢‘ç‡é™åˆ¶ï¼Œæˆ‘ä»¬åœ¨ `MarketDataService` ä¸­å¢åŠ äº†è¯·æ±‚é—´éš”åŠŸèƒ½ã€‚è¯¥åŠŸèƒ½å¯ä»¥åœ¨æ¯æ¬¡ API è¯·æ±‚ä¹‹é—´æ·»åŠ å¯é…ç½®çš„å»¶è¿Ÿæ—¶é—´ã€‚

## åŠŸèƒ½ç‰¹ç‚¹

- **å¯é…ç½®å»¶è¿Ÿ**: æ”¯æŒè®¾ç½®ä»»æ„çš„è¯·æ±‚é—´éš”æ—¶é—´ï¼ˆç§’ï¼‰
- **çº¿ç¨‹å®‰å…¨**: åœ¨å¤šçº¿ç¨‹å¹¶å‘ç¯å¢ƒä¸‹æ­£ç¡®å·¥ä½œ
- **æ™ºèƒ½æ§åˆ¶**: åªåœ¨éœ€è¦æ—¶æ·»åŠ å»¶è¿Ÿï¼Œé¿å…ä¸å¿…è¦çš„ç­‰å¾…
- **è¯¦ç»†æ—¥å¿—**: è®°å½•å»¶è¿Ÿä¿¡æ¯ä¾¿äºè°ƒè¯•å’Œç›‘æ§

## ä½¿ç”¨æ–¹æ³•

### 1. get_perpetual_data æ–¹æ³•

```python
from cryptoservice.services.market_service import MarketDataService
from cryptoservice.models import Freq

service = MarketDataService(api_key="your_key", api_secret="your_secret")

# ä½¿ç”¨é»˜è®¤è¯·æ±‚é—´éš” (0.5ç§’)
report = service.get_perpetual_data(
    symbols=["BTCUSDT", "ETHUSDT"],
    start_time="2024-12-01",
    end_time="2024-12-02",
    db_path="./data/market.db",
    interval=Freq.h1,
)

# ä½¿ç”¨è‡ªå®šä¹‰è¯·æ±‚é—´éš” (2ç§’)
report = service.get_perpetual_data(
    symbols=["BTCUSDT", "ETHUSDT"],
    start_time="2024-12-01",
    end_time="2024-12-02",
    db_path="./data/market.db",
    interval=Freq.h1,
    request_delay=2.0,  # 2ç§’é—´éš”
)

# æ— è¯·æ±‚é—´éš”ï¼ˆä¸æ¨èï¼‰
report = service.get_perpetual_data(
    symbols=["BTCUSDT", "ETHUSDT"],
    start_time="2024-12-01",
    end_time="2024-12-02",
    db_path="./data/market.db",
    interval=Freq.h1,
    request_delay=0.0,  # æ— å»¶è¿Ÿ
)
```

### 2. download_universe_data æ–¹æ³•

```python
# ä¸‹è½½ Universe æ•°æ®æ—¶è®¾ç½®è¯·æ±‚é—´éš”
service.download_universe_data(
    universe_file="./universe.json",
    db_path="./data/market.db",
    interval=Freq.m1,
    max_workers=4,
    request_delay=1.0,  # 1ç§’é—´éš”
)
```

## å‚æ•°è¯´æ˜

### request_delay

- **ç±»å‹**: float
- **é»˜è®¤å€¼**: 0.5 ç§’
- **è¯´æ˜**: æ¯æ¬¡ API è¯·æ±‚ä¹‹é—´çš„å»¶è¿Ÿæ—¶é—´ï¼ˆç§’ï¼‰

## æ¨èé…ç½®

### æ ¹æ®å¹¶å‘æ•°é€‰æ‹©å»¶è¿Ÿ

| å¹¶å‘çº¿ç¨‹æ•° | æ¨èå»¶è¿Ÿæ—¶é—´ | è¯´æ˜ |
|------------|--------------|------|
| 1          | 0.2-0.5ç§’    | å•çº¿ç¨‹ï¼Œè¾ƒå°å»¶è¿Ÿå³å¯ |
| 2-4        | 0.5-1.0ç§’    | ä¸­ç­‰å¹¶å‘ï¼Œå¹³è¡¡é€Ÿåº¦å’Œç¨³å®šæ€§ |
| 5-10       | 1.0-2.0ç§’    | é«˜å¹¶å‘ï¼Œéœ€è¦æ›´é•¿å»¶è¿Ÿ |
| 10+        | 2.0ç§’ä»¥ä¸Š    | æé«˜å¹¶å‘ï¼Œè°¨æ…ä½¿ç”¨ |

### æ ¹æ®æ•°æ®é‡é€‰æ‹©å»¶è¿Ÿ

- **å°‘é‡æ•°æ®** (< 100ä¸ªäº¤æ˜“å¯¹): 0.5ç§’
- **ä¸­é‡æ•°æ®** (100-500ä¸ªäº¤æ˜“å¯¹): 1.0ç§’
- **å¤§é‡æ•°æ®** (500+ä¸ªäº¤æ˜“å¯¹): 2.0ç§’æˆ–æ›´å¤š

## å®ç°åŸç†

1. **çº¿ç¨‹é”æ§åˆ¶**: ä½¿ç”¨ `threading.Lock()` ç¡®ä¿åœ¨å¤šçº¿ç¨‹ç¯å¢ƒä¸‹æ­£ç¡®æ§åˆ¶è¯·æ±‚é—´éš”
2. **æ—¶é—´å·®è®¡ç®—**: è®°å½•ä¸Šæ¬¡è¯·æ±‚æ—¶é—´ï¼Œè®¡ç®—ä¸å½“å‰æ—¶é—´çš„å·®å€¼
3. **æ™ºèƒ½å»¶è¿Ÿ**: åªåœ¨æ—¶é—´å·®å°äºè®¾å®šé—´éš”æ—¶æ‰æ‰§è¡Œå»¶è¿Ÿ
4. **ç²¾ç¡®æ§åˆ¶**: ä½¿ç”¨ `time.sleep()` è¿›è¡Œç²¾ç¡®çš„æ—¶é—´æ§åˆ¶

## æ ¸å¿ƒä»£ç é€»è¾‘

```python
# ç”¨äºæ§åˆ¶è¯·æ±‚é—´éš”çš„é”å’Œè®¡æ—¶å™¨
request_lock = Lock()
last_request_time = [0.0]

def process_symbol(symbol: str):
    # æ§åˆ¶è¯·æ±‚é—´éš”
    with request_lock:
        current_time = time.time()
        time_since_last = current_time - last_request_time[0]
        if time_since_last < request_delay:
            sleep_time = request_delay - time_since_last
            logger.debug(f"ç­‰å¾… {sleep_time:.2f}ç§’ - {symbol}")
            time.sleep(sleep_time)
        last_request_time[0] = time.time()

    # æ‰§è¡Œ API è¯·æ±‚
    data = self._fetch_symbol_data(...)
```

## æ—¥å¿—è¾“å‡º

å¯ç”¨è¯·æ±‚é—´éš”åŠŸèƒ½åï¼Œæ‚¨å°†çœ‹åˆ°ç±»ä¼¼çš„æ—¥å¿—è¾“å‡ºï¼š

```
ğŸš€ å¼€å§‹ä¸‹è½½ 3 ä¸ªäº¤æ˜“å¯¹çš„æ•°æ®
ğŸ“… æ—¶é—´èŒƒå›´: 2024-12-01 åˆ° 2024-12-02
âš™ï¸ é‡è¯•é…ç½®: æœ€å¤§3æ¬¡, åŸºç¡€å»¶è¿Ÿ1.0ç§’
â±ï¸ è¯·æ±‚é—´éš”: 1.0ç§’
ç­‰å¾… 0.83ç§’ - ETHUSDT
ç­‰å¾… 0.91ç§’ - BNBUSDT
âœ… BTCUSDT: 24 æ¡è®°å½•
âœ… ETHUSDT: 24 æ¡è®°å½•
âœ… BNBUSDT: 24 æ¡è®°å½•
```

## æ³¨æ„äº‹é¡¹

1. **ç½‘ç»œç¯å¢ƒ**: ç½‘ç»œå»¶è¿Ÿè¾ƒé«˜æ—¶å¯ä»¥é€‚å½“å‡å°‘è¯·æ±‚é—´éš”
2. **APIé™åˆ¶**: ä¸åŒçš„APIç«¯ç‚¹å¯èƒ½æœ‰ä¸åŒçš„é¢‘ç‡é™åˆ¶
3. **æ€§èƒ½å¹³è¡¡**: å»¶è¿Ÿæ—¶é—´è¶Šé•¿è¶Šå®‰å…¨ï¼Œä½†ä¸‹è½½é€Ÿåº¦ä¼šç›¸åº”å˜æ…¢
4. **ç›‘æ§æ—¥å¿—**: æ³¨æ„è§‚å¯Ÿæ˜¯å¦ä»æœ‰é¢‘ç‡é™åˆ¶é”™è¯¯
5. **é”™è¯¯é‡è¯•**: å³ä½¿è®¾ç½®äº†è¯·æ±‚é—´éš”ï¼Œä»ç„¶ä¿ç•™äº†é”™è¯¯é‡è¯•æœºåˆ¶

## æ•…éšœæ’é™¤

### ä»ç„¶å‡ºç°é¢‘ç‡é™åˆ¶é”™è¯¯

1. å¢åŠ  `request_delay` å€¼
2. å‡å°‘ `max_workers` å¹¶å‘æ•°
3. æ£€æŸ¥ç½‘ç»œè¿æ¥ç¨³å®šæ€§

### ä¸‹è½½é€Ÿåº¦å¤ªæ…¢

1. é€‚å½“å‡å°‘ `request_delay` å€¼
2. å¢åŠ  `max_workers` å¹¶å‘æ•°ï¼ˆè°¨æ…ï¼‰
3. åœ¨ç¨³å®šçš„ç½‘ç»œç¯å¢ƒä¸‹è¿è¡Œ

### æ—¥å¿—è¿‡å¤š

1. è°ƒæ•´æ—¥å¿—çº§åˆ«ï¼š`logging.getLogger().setLevel(logging.INFO)`
2. æˆ–è€…ç¦ç”¨è°ƒè¯•æ—¥å¿—ï¼š`logger.debug` è¾“å‡º

## ç¤ºä¾‹è„šæœ¬

å®Œæ•´çš„ç¤ºä¾‹è„šæœ¬è¯·å‚è€ƒ `example_request_delay.py`ï¼Œè¯¥è„šæœ¬æ¼”ç¤ºäº†ä¸åŒè¯·æ±‚é—´éš”é…ç½®çš„æ•ˆæœã€‚
