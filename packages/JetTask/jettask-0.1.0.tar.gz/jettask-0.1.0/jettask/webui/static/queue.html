<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é˜Ÿåˆ—è¯¦æƒ… - Fastlane Monitor</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background-color: #f5f5f5;
            color: #333;
            height: 100vh;
            overflow: hidden;
        }

        .main-layout {
            display: flex;
            height: 100vh;
            position: relative;
        }

        .sidebar {
            width: 400px;
            min-width: 300px;
            max-width: 800px;
            background: white;
            border-right: 1px solid #e0e0e0;
            padding: 0;
            flex-shrink: 0;
            display: flex;
            flex-direction: column;
            position: relative;
            overflow-x: hidden;
        }

        .sidebar-resizer {
            position: absolute;
            top: 0;
            right: -3px;
            width: 6px;
            height: 100%;
            cursor: col-resize;
            background: transparent;
            z-index: 100;
        }

        .sidebar-resizer:hover {
            background: #3498db;
        }

        .sidebar-resizer.resizing {
            background: #3498db;
        }

        .content-area {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }


        h1 {
            font-size: 1.5em;
            margin: 0;
            line-height: 30px;
        }

        .back-link {
            color: #2c3e50;
            text-decoration: none;
            padding: 10px 20px;
            border: 1px solid #ddd;
            border-radius: 4px;
            transition: all 0.3s ease;
            background: #f8f9fa;
            font-weight: 500;
        }

        .back-link:hover {
            background-color: #e9ecef;
            border-color: #adb5bd;
        }


        .queue-stats-inline {
            display: flex;
            align-items: center;
            gap: 15px;
            font-size: 0.95em;
        }

        .stat-item {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .stat-label {
            color: #7f8c8d;
        }

        .stat-value {
            font-weight: bold;
            color: #2c3e50;
        }

        .stat-divider {
            color: #ddd;
        }

        .info-label {
            color: #7f8c8d;
            font-size: 0.9em;
        }

        /* å¯æŠ˜å éƒ¨åˆ†æ ·å¼ */
        .collapsible .section-header {
            cursor: pointer;
            user-select: none;
        }

        .collapsible .section-header:hover {
            background-color: #f8f9fa;
        }

        .collapse-icon {
            display: inline-block;
            transition: transform 0.3s ease;
            font-size: 0.8em;
        }

        .collapse-icon.collapsed {
            transform: rotate(-90deg);
        }

        .collapsible-content {
            transition: max-height 0.3s ease, opacity 0.3s ease;
            overflow: hidden;
        }

        .collapsible-content.collapsed {
            max-height: 0;
            opacity: 0;
        }

        .section {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #ecf0f1;
        }

        .section h3 {
            color: #2c3e50;
            font-size: 1.3em;
        }

        .controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 10px;
        }

        .filter-bar {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .filter-bar input {
            padding: 8px 15px;
            border: 1px solid #ddd;
            border-radius: 4px;
            width: 250px;
            font-size: 0.95em;
        }

        .filter-bar select {
            padding: 8px 15px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 0.95em;
        }


        table {
            width: 100%;
            border-collapse: collapse;
        }

        th {
            background-color: #ecf0f1;
            padding: 12px;
            text-align: left;
            font-weight: 600;
            color: #2c3e50;
            white-space: nowrap;
        }

        td {
            padding: 12px;
            border-bottom: 1px solid #ecf0f1;
        }

        tr:hover {
            background-color: #f8f9fa;
        }

        .status-badge {
            display: inline-block;
            padding: 3px 10px;
            border-radius: 12px;
            font-size: 0.8em;
            font-weight: 500;
        }

        .status-pending {
            background-color: #f39c12;
            color: white;
        }

        .status-running {
            background-color: #3498db;
            color: white;
        }

        .status-success {
            background-color: #27ae60;
            color: white;
        }

        .status-error {
            background-color: #e74c3c;
            color: white;
        }

        .pagination {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
            margin-top: 20px;
        }

        .pagination button {
            padding: 8px 15px;
            border: 1px solid #ddd;
            background: white;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.95em;
            transition: all 0.2s;
        }

        .pagination button:hover:not(:disabled) {
            background-color: #3498db;
            color: white;
            border-color: #3498db;
        }

        .pagination button:disabled {
            cursor: not-allowed;
            opacity: 0.5;
        }

        .pagination button.active {
            background-color: #3498db;
            color: white;
            border-color: #3498db;
        }

        .page-info {
            color: #7f8c8d;
            font-size: 0.9em;
        }

        .workers-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 10px;
        }

        .worker-card {
            background: #f8f9fa;
            padding: 10px 15px;
            border-radius: 6px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.9em;
        }

        .worker-info {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .worker-details {
            line-height: 1.3;
        }

        .worker-id {
            font-weight: bold;
            color: #2c3e50;
        }

        .worker-meta {
            font-size: 0.85em;
            color: #666;
        }

        .worker-status {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
        }

        .worker-alive {
            background-color: #27ae60;
        }

        .worker-dead {
            background-color: #e74c3c;
        }

        .empty-state {
            text-align: center;
            padding: 40px;
            color: #7f8c8d;
        }

        .loading {
            text-align: center;
            padding: 20px;
            color: #7f8c8d;
        }

        .task-id {
            font-family: monospace;
            font-size: 0.9em;
            color: #34495e;
        }

        .truncate {
            max-width: 300px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .action-btn {
            padding: 4px 12px;
            border: 1px solid #3498db;
            background: white;
            color: #3498db;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.85em;
            transition: all 0.2s;
        }

        .action-btn:hover {
            background: #3498db;
            color: white;
        }

        .action-btn:disabled {
            border-color: #ccc;
            color: #ccc;
            cursor: not-allowed;
        }

        .action-btn:disabled:hover {
            background: white;
            color: #ccc;
        }

        .result-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .result-modal.show {
            display: flex;
        }

        .modal-content {
            background: white;
            padding: 20px;
            border-radius: 8px;
            width: 600px;
            max-width: 90vw;
            max-height: 80vh;
            overflow: auto;
            position: relative;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #eee;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 1.5em;
            cursor: pointer;
            color: #999;
        }

        .modal-close:hover {
            color: #333;
        }

        .result-content {
            font-family: monospace;
            white-space: pre-wrap;
            word-break: break-all;
            background: #f5f5f5;
            padding: 15px;
            border-radius: 4px;
        }

        /* æ—¶é—´é€‰æ‹©å™¨æ ·å¼ */
        .time-picker-container {
            background: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }

        .time-picker-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .quick-select-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .quick-select-btn {
            padding: 6px 12px;
            border: 1px solid #ddd;
            background: white;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.9em;
            transition: all 0.2s;
        }

        .quick-select-btn:hover {
            background: #f0f0f0;
        }

        .quick-select-btn.active {
            background: #3498db;
            color: white;
            border-color: #3498db;
        }

        .timeline-container {
            position: relative;
            height: 100px;
            background: #f8f9fa;
            border: 1px solid #ddd;
            border-radius: 4px;
            margin: 15px 0;
            cursor: crosshair;
            overflow: hidden;
        }

        .timeline-chart {
            position: absolute;
            bottom: 0;
            width: 100%;
            height: 80%;
            display: flex;
            align-items: flex-end;
            padding: 0 5px;
        }

        .timeline-bar {
            flex: 1;
            background: #3498db;
            margin: 0 1px;
            min-height: 2px;
            transition: opacity 0.2s;
        }

        .timeline-bar:hover {
            opacity: 0.8;
        }

        .timeline-selection {
            position: absolute;
            top: 0;
            height: 100%;
            background: rgba(52, 152, 219, 0.2);
            border-left: 2px solid #3498db;
            border-right: 2px solid #3498db;
            pointer-events: none;
        }

        .timeline-axis {
            position: absolute;
            bottom: 0;
            width: 100%;
            height: 20%;
            display: flex;
            justify-content: space-between;
            padding: 0 5px;
            font-size: 0.8em;
            color: #666;
        }

        .time-range-display {
            display: flex;
            gap: 20px;
            align-items: center;
            margin-top: 10px;
            font-size: 0.9em;
        }

        .time-range-item {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .time-range-label {
            color: #666;
        }

        .time-range-value {
            font-weight: bold;
            color: #333;
        }

        .custom-time-inputs {
            display: flex;
            gap: 10px;
            align-items: center;
            margin-top: 10px;
        }

        .custom-time-inputs input[type="datetime-local"] {
            padding: 6px 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 0.9em;
        }

        .apply-time-btn {
            padding: 6px 15px;
            background: #3498db;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.9em;
        }

        .apply-time-btn:hover {
            background: #2980b9;
        }

        .refresh-controls {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .refresh-select {
            padding: 6px 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 0.9em;
            background: white;
        }

        .last-refresh-time {
            font-size: 0.85em;
            color: #666;
        }

        .loading-more {
            text-align: center;
            padding: 20px;
            color: #666;
            font-style: italic;
        }

        /* ä¾§è¾¹æ æ ·å¼ */
        .sidebar-section {
            background: #f8f9fa;
            padding: 15px;
            margin: 0 20px 20px 20px;
        }

        .sidebar-section h4 {
            color: #2c3e50;
            font-size: 1.1em;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #ddd;
        }

        /* Workersè¡¨æ ¼æ ·å¼ */
        .workers-table-container {
            max-height: 500px;
            overflow-y: auto;
            overflow-x: auto;
            border: 1px solid #e0e0e0;
            border-radius: 4px;
            background: white;
            margin-top: 10px;
        }

        .workers-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.85em;
        }

        .workers-table th {
            background: #f8f9fa;
            padding: 8px;
            text-align: left;
            font-weight: 600;
            border-bottom: 2px solid #ddd;
            position: sticky;
            top: 0;
            z-index: 10;
            white-space: nowrap;
        }

        .workers-table td {
            padding: 8px;
            border-bottom: 1px solid #f0f0f0;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 150px;
        }

        .workers-table td:nth-child(2) {
            max-width: 200px;
        }

        .workers-table tr:hover {
            background: #f8f9fa;
        }

        .worker-stat {
            display: inline-block;
            margin-right: 10px;
            font-size: 0.9em;
        }

        .worker-stat-label {
            color: #666;
            margin-right: 5px;
        }

        .worker-stat-value {
            font-weight: 600;
        }

        .worker-status {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            margin-right: 8px;
        }

        .worker-status.alive {
            background-color: #27ae60;
        }

        .worker-status.dead {
            background-color: #e74c3c;
        }

        /* å‚æ•°æ˜¾ç¤ºé™åˆ¶ */
        .params-cell {
            max-width: 300px;
            cursor: pointer;
            position: relative;
        }

        .params-text {
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            display: block;
        }

        .params-cell:hover {
            background-color: #f0f0f0;
        }

        /* å‚æ•°è¯¦æƒ…å¼¹çª— */
        .params-modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
        }

        .params-modal-content {
            background-color: #fff;
            margin: 10% auto;
            padding: 20px;
            border: 1px solid #888;
            width: 80%;
            max-width: 600px;
            border-radius: 8px;
            max-height: 70vh;
            overflow-y: auto;
        }

        .params-modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #ddd;
        }

        .params-close {
            color: #aaa;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            line-height: 20px;
        }

        .params-close:hover {
            color: #000;
        }

        /* è¾¾åˆ°é™åˆ¶æç¤º */
        .limit-warning {
            background-color: #fff3cd;
            border: 1px solid #ffebc4;
            color: #856404;
            padding: 15px;
            border-radius: 4px;
            margin: 20px 0;
            text-align: center;
        }

        .limit-warning strong {
            display: block;
            margin-bottom: 5px;
        }

        /* Kibanaé£æ ¼çš„æ—¶é—´æ§åˆ¶ */
        .kibana-time-controls {
            position: absolute;
            top: 10px;
            right: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
            background: white;
            padding: 8px 12px;
            border-radius: 4px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            z-index: 50;
        }

        .time-display {
            display: flex;
            align-items: center;
            gap: 5px;
            padding: 6px 12px;
            background: #f0f0f0;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.9em;
            min-width: 200px;
        }

        .time-display:hover {
            background: #e0e0e0;
        }

        .time-icon {
            color: #666;
        }

        .refresh-button {
            padding: 6px 10px;
            background: #3498db;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .refresh-button:hover {
            background: #2980b9;
        }

        .auto-refresh-select {
            padding: 6px 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 0.9em;
            background: white;
            cursor: pointer;
        }

        /* é˜Ÿåˆ—ä¿¡æ¯æ ·å¼ */
        .info-row {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid #f0f0f0;
            font-size: 0.9em;
        }

        .info-row:last-child {
            border-bottom: none;
        }

        .info-value {
            font-weight: 600;
            color: #2c3e50;
        }
        
        /* ç»Ÿè®¡æ¨¡å¼æŒ‰é’®æ ·å¼ */
        .stats-mode-btn {
            transition: all 0.2s ease;
        }
        
        .stats-mode-btn:hover {
            opacity: 0.9;
        }
        
        .stats-mode-btn:active {
            transform: scale(0.98);
        }
    </style>
</head>

<body>
    <div class="main-layout" style="height: 100vh;">
        <!-- ä¾§è¾¹æ  -->
        <div class="sidebar" id="sidebar">
            <!-- æ‹–æ‹½è°ƒæ•´å¤§å°çš„æ¡ -->
            <div class="sidebar-resizer" id="sidebarResizer"></div>
            <!-- æ ‡é¢˜å’Œè¿”å› -->
            <div style="padding: 20px 20px 0; margin-bottom: 20px; border-bottom: 1px solid #e0e0e0;">
                <h2 style="font-size: 1.2em; margin: 0 0 15px 0; color: #2c3e50;">Fastlane Monitor</h2>
                <a href="/" class="back-link" style="display: block; text-align: center; margin-bottom: 20px;">â†
                    è¿”å›é¦–é¡µ</a>
            </div>

            <!-- é˜Ÿåˆ—ä¿¡æ¯ -->
            <div class="sidebar-section">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                    <h4 style="margin: 0;">é˜Ÿåˆ—ä¿¡æ¯</h4>
                    <div style="display: flex;">
                        <button id="allStatsBtn" class="stats-mode-btn active" style="padding: 4px 10px; font-size: 12px; border: 1px solid #3498db; background: #3498db; color: white; border-radius: 4px 0 0 4px; cursor: pointer; border-right: none;">
                            æ‰€æœ‰
                        </button>
                        <button id="onlineStatsBtn" class="stats-mode-btn" style="padding: 4px 10px; font-size: 12px; border: 1px solid #3498db; background: white; color: #3498db; border-radius: 0 4px 4px 0; cursor: pointer;">
                            åœ¨çº¿
                        </button>
                    </div>
                </div>
                <div class="queue-info-details">
                    <div class="info-row">
                        <span class="info-label">é˜Ÿåˆ—åç§°:</span>
                        <span class="info-value" id="sidebarQueueName">-</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">é˜Ÿåˆ—é•¿åº¦:</span>
                        <span class="info-value" id="sidebarQueueLength">-</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">æ¶ˆè´¹è€…ç»„:</span>
                        <span class="info-value" id="sidebarConsumerGroups">-</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">åœ¨çº¿Workers:</span>
                        <span class="info-value"><span id="sidebarOnlineWorkers">-</span>/<span
                                id="sidebarTotalWorkers">-</span></span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">æˆåŠŸæ¬¡æ•°:</span>
                        <span class="info-value" id="totalSuccessCount">-</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">å¤±è´¥æ¬¡æ•°:</span>
                        <span class="info-value" id="totalFailedCount">-</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">æ€»è®¡:</span>
                        <span class="info-value" id="totalTaskCount">-</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">æ‰§è¡Œä¸­:</span>
                        <span class="info-value" id="totalRunningTasks">-</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">å¹³å‡å¤„ç†æ—¶é—´:</span>
                        <span class="info-value" id="avgProcessingTime">-</span>
                    </div>
                </div>
            </div>

            <!-- Workersåˆ—è¡¨ -->
            <div class="sidebar-section" style="flex: 1; display: flex; flex-direction: column;">
                <h4>
                    Workers (<span id="workersSummary">-</span>)
                    <button class="action-btn" style="float: right; font-size: 12px; padding: 2px 8px;" onclick="showWorkerHistory()">å†å²è®°å½•</button>
                </h4>
                <div class="workers-table-container" id="workersContainer" style="flex: 1;">
                    <div class="loading" style="padding: 20px; text-align: center;">åŠ è½½ä¸­...</div>
                </div>
                <div class="info-label" style="margin-top: 10px; text-align: center;">
                    æœ€åæ›´æ–°: <span id="workersLastUpdate">-</span>
                </div>
            </div>
        </div>

        <!-- ä¸»å†…å®¹åŒº -->
        <div class="content-area" style="position: relative;">
            <!-- Kibanaé£æ ¼çš„æ—¶é—´å’Œåˆ·æ–°æ§åˆ¶ -->
            <div class="kibana-time-controls">
                <span id="lastRefreshTime" style="color: #666; font-size: 12px; margin-right: 15px;"></span>
                <div style="width: 1px; height: 24px; background: #ddd; margin-right: 10px;"></div>
                <div class="time-display" onclick="toggleTimeMenu()" title="ç‚¹å‡»é€‰æ‹©æ—¶é—´èŒƒå›´">
                    <span class="time-icon">ğŸ“…</span>
                    <span id="currentTimeRange">æœ€è¿‘1å°æ—¶</span>
                    <span style="margin-left: auto;">â–¼</span>
                </div>
                <div style="width: 1px; height: 24px; background: #ddd;"></div>
                <select id="refreshInterval" onchange="updateRefreshInterval()" class="auto-refresh-select"
                    title="è‡ªåŠ¨åˆ·æ–°é—´éš”">
                    <option value="0">ğŸ”„ å…³é—­åˆ·æ–°</option>
                    <option value="5">ğŸ”„ 5ç§’</option>
                    <option value="10">ğŸ”„ 10ç§’</option>
                    <option value="30" selected>ğŸ”„ 30ç§’</option>
                    <option value="60">ğŸ”„ 1åˆ†é’Ÿ</option>
                    <option value="300">ğŸ”„ 5åˆ†é’Ÿ</option>
                </select>
                <button class="refresh-button" onclick="refreshData()" title="ç«‹å³åˆ·æ–°">
                    <span style="transform: scaleX(-1); display: inline-block;">â†»</span>
                    åˆ·æ–°
                </button>
            </div>

            <!-- æ—¶é—´é€‰æ‹©ä¸‹æ‹‰èœå• -->
            <div id="timeMenu"
                style="display: none; position: absolute; top: 60px; right: 20px; background: white; border-radius: 4px; box-shadow: 0 2px 8px rgba(0,0,0,0.15); z-index: 100; padding: 15px; min-width: 320px;">
                <div style="font-weight: 600; margin-bottom: 10px; padding: 5px;">å¿«é€Ÿé€‰æ‹©</div>
                <div class="quick-select-buttons"
                    style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 5px; margin-bottom: 15px;">
                    <button class="quick-select-btn" onclick="selectTimeRange('10m')">æœ€è¿‘10åˆ†é’Ÿ</button>
                    <button class="quick-select-btn" onclick="selectTimeRange('30m')">æœ€è¿‘30åˆ†é’Ÿ</button>
                    <button class="quick-select-btn" onclick="selectTimeRange('1h')">æœ€è¿‘1å°æ—¶</button>
                    <button class="quick-select-btn" onclick="selectTimeRange('6h')">æœ€è¿‘6å°æ—¶</button>
                    <button class="quick-select-btn" onclick="selectTimeRange('12h')">æœ€è¿‘12å°æ—¶</button>
                    <button class="quick-select-btn" onclick="selectTimeRange('1d')">æœ€è¿‘1å¤©</button>
                    <button class="quick-select-btn" onclick="selectTimeRange('7d')">æœ€è¿‘7å¤©</button>
                </div>

                <div style="border-top: 1px solid #eee; padding-top: 15px;">
                    <div style="font-weight: 600; margin-bottom: 10px;">è‡ªå®šä¹‰æ—¶é—´èŒƒå›´</div>
                    <div style="display: flex; flex-direction: column; gap: 10px;">
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <label style="min-width: 40px; font-size: 0.9em;">å¼€å§‹:</label>
                            <input type="datetime-local" id="customStartTime"
                                style="flex: 1; padding: 6px; border: 1px solid #ddd; border-radius: 4px; font-size: 0.9em;">
                        </div>
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <label style="min-width: 40px; font-size: 0.9em;">ç»“æŸ:</label>
                            <input type="datetime-local" id="customEndTime"
                                style="flex: 1; padding: 6px; border: 1px solid #ddd; border-radius: 4px; font-size: 0.9em;">
                        </div>
                        <button class="apply-time-btn" onclick="applyCustomTime()"
                            style="align-self: flex-end; padding: 8px 16px; background: #3498db; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 0.9em;">åº”ç”¨</button>
                    </div>
                </div>
            </div>

            <!-- æ—¶é—´é€‰æ‹©å™¨ -->
            <div class="time-picker-container" style="margin-top: 60px;">
                <div class="time-picker-header" style="display: none;">
                    <h3>æ—¶é—´èŒƒå›´</h3>
                </div>

                <div class="timeline-container" id="timelineContainer">
                    <div class="timeline-chart" id="timelineChart"></div>
                    <div class="timeline-axis" id="timelineAxis"></div>
                    <div class="timeline-selection" id="timelineSelection" style="display: none;"></div>
                </div>

                <div class="time-range-display">
                    <div class="time-range-item">
                        <span class="time-range-label">å¼€å§‹æ—¶é—´:</span>
                        <span class="time-range-value" id="selectedStartTime">-</span>
                    </div>
                    <div class="time-range-item">
                        <span class="time-range-label">ç»“æŸæ—¶é—´:</span>
                        <span class="time-range-value" id="selectedEndTime">-</span>
                    </div>
                </div>

            </div>

            <!-- ä»»åŠ¡åˆ—è¡¨ -->
            <div class="section">
                <div class="section-header">
                    <h3>ä»»åŠ¡åˆ—è¡¨</h3>
                    <span class="info-label">æ€»ä»»åŠ¡æ•°: <span id="totalTasks">-</span></span>
                </div>

                <div class="controls">
                    <div class="filter-bar">
                        <input type="text" id="taskFilter" placeholder="æœç´¢ä»»åŠ¡IDæˆ–çŠ¶æ€...">
                        <select id="statusFilter">
                            <option value="">æ‰€æœ‰çŠ¶æ€</option>
                            <option value="pending">å¾…å¤„ç†</option>
                            <option value="running">è¿è¡Œä¸­</option>
                            <option value="success">æˆåŠŸ</option>
                            <option value="error">å¤±è´¥</option>
                            <option value="æœªçŸ¥">æœªçŸ¥</option>
                        </select>
                    </div>
                </div>

                <div id="tasksContainer">
                    <table id="tasksTable">
                        <thead>
                            <tr>
                                <th>ä»»åŠ¡ID</th>
                                <th>å‚æ•°</th>
                                <th>æ¶ˆè´¹è€…</th>
                                <th>çŠ¶æ€</th>
                                <th>åˆ›å»ºæ—¶é—´</th>
                                <th>å®Œæˆæ—¶é—´</th>
                                <th>è€—æ—¶</th>
                                <th>æ“ä½œ</th>
                            </tr>
                        </thead>
                        <tbody id="tasksBody">
                            <tr>
                                <td colspan="8" class="loading">åŠ è½½ä¸­...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>

            </div>
        </div>
    </div>

    <script>
        // è·å–URLå‚æ•°
        const urlParams = new URLSearchParams(window.location.search);
        const queueName = urlParams.get('name') || '';

        let currentStartTime = null;
        let currentEndTime = null;
        const pageSize = 100;  // å›ºå®šæ¯æ¬¡åŠ è½½100æ¡
        let oldestId = null;
        let newestId = null;
        let hasMore = false;
        let workers = [];
        let queueStats = null;
        
        // ä» localStorage è¯»å–ç”¨æˆ·çš„é€‰æ‹©ï¼Œé»˜è®¤ä¸ºæ˜¾ç¤ºæ‰€æœ‰ç»Ÿè®¡
        let showAllStats = localStorage.getItem('statsMode') !== 'online';

        // æ— é™æ»šåŠ¨ç›¸å…³å˜é‡
        let allTasks = [];  // å­˜å‚¨æ‰€æœ‰å·²åŠ è½½çš„ä»»åŠ¡
        let isLoadingMore = false;
        let noMoreData = false;

        // æ—¶é—´é€‰æ‹©å™¨ç›¸å…³å˜é‡
        let timelineData = [];
        let selectedTimeRange = '1h';
        let isSelectingTime = false;
        let selectionStartX = 0;
        let timelineStartTime = 0;
        let timelineEndTime = 0;

        // åˆ·æ–°ç›¸å…³å˜é‡
        let refreshIntervalId = null;
        let lastRefreshTime = null;

        // UIçŠ¶æ€
        let sectionStates = {
            workers: false  // é»˜è®¤æŠ˜å 
        };

        // åˆ‡æ¢éƒ¨åˆ†çš„æŠ˜å /å±•å¼€çŠ¶æ€
        function toggleSection(sectionName) {
            sectionStates[sectionName] = !sectionStates[sectionName];
            const icon = document.getElementById(`${sectionName}-icon`);
            const content = document.getElementById(`${sectionName}Container`);

            if (sectionStates[sectionName]) {
                icon.classList.remove('collapsed');
                content.classList.remove('collapsed');
            } else {
                icon.classList.add('collapsed');
                content.classList.add('collapsed');
            }
        }

        // æ ¼å¼åŒ–æ—¶é—´
        function formatTime(timestamp) {
            if (!timestamp) return '-';
            const date = new Date(timestamp);
            return date.toLocaleString('zh-CN');
        }

        // è·å–çŠ¶æ€æ ·å¼ç±»
        function getStatusClass(status) {
            const statusMap = {
                'pending': 'status-pending',
                'running': 'status-running',
                'success': 'status-success',
                'error': 'status-error',
                'failed': 'status-error',
                'æœªçŸ¥': 'status-pending',
                'unknown': 'status-pending'
            };
            return statusMap[status?.toLowerCase()] || 'status-pending';
        }

        // è§£æä»»åŠ¡çŠ¶æ€
        function parseTaskStatus(statusStr) {
            try {
                return JSON.parse(statusStr);
            } catch {
                return { status: statusStr || 'unknown' };
            }
        }

        // å¤åˆ¶åˆ°å‰ªè´´æ¿
        function copyToClipboard(text, event) {
            if (event) {
                event.stopPropagation();
            }

            // åˆ›å»ºä¸´æ—¶æ–‡æœ¬åŒºåŸŸ
            const textArea = document.createElement("textarea");
            textArea.value = text;
            textArea.style.position = "fixed";
            textArea.style.left = "-999999px";
            textArea.style.top = "-999999px";
            document.body.appendChild(textArea);

            try {
                textArea.focus();
                textArea.select();

                // å°è¯•ä½¿ç”¨æ–°çš„ Clipboard API
                if (navigator.clipboard && window.isSecureContext) {
                    navigator.clipboard.writeText(text).then(() => {
                        // æ˜¾ç¤ºæˆåŠŸæç¤º
                        showCopyToast('å·²å¤åˆ¶åˆ°å‰ªè´´æ¿');
                    }).catch(() => {
                        // é™çº§åˆ°æ—§æ–¹æ³•
                        fallbackCopy();
                    });
                } else {
                    // ä½¿ç”¨æ—§çš„ execCommand æ–¹æ³•
                    fallbackCopy();
                }

                function fallbackCopy() {
                    try {
                        document.execCommand('copy');
                        showCopyToast('å·²å¤åˆ¶åˆ°å‰ªè´´æ¿');
                    } catch (err) {
                        console.error('å¤åˆ¶å¤±è´¥:', err);
                        showCopyToast('å¤åˆ¶å¤±è´¥', true);
                    }
                }
            } finally {
                document.body.removeChild(textArea);
            }
        }

        // æ˜¾ç¤ºå¤åˆ¶æç¤º
        function showCopyToast(message, isError = false) {
            const toast = document.createElement('div');
            toast.textContent = message;
            toast.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                padding: 10px 20px;
                background: ${isError ? '#e74c3c' : '#27ae60'};
                color: white;
                border-radius: 4px;
                box-shadow: 0 2px 4px rgba(0,0,0,0.2);
                z-index: 10000;
                transition: opacity 0.3s ease;
                font-size: 14px;
            `;
            document.body.appendChild(toast);

            setTimeout(() => {
                toast.style.opacity = '0';
                setTimeout(() => {
                    document.body.removeChild(toast);
                }, 300);
            }, 2000);
        }

        // æ˜¾ç¤ºé€šçŸ¥æç¤ºï¼ˆæ”¯æŒä¸åŒç±»å‹ï¼‰
        function showNotification(message, type = 'info') {
            const colorMap = {
                'info': '#3498db',
                'success': '#27ae60',
                'warning': '#f39c12',
                'error': '#e74c3c'
            };

            const toast = document.createElement('div');
            toast.textContent = message;
            toast.style.cssText = `
                position: fixed;
                top: 70px;
                right: 20px;
                padding: 12px 24px;
                background: ${colorMap[type] || colorMap.info};
                color: white;
                border-radius: 4px;
                box-shadow: 0 2px 8px rgba(0,0,0,0.2);
                z-index: 10000;
                transition: all 0.3s ease;
                font-size: 14px;
                max-width: 400px;
                word-wrap: break-word;
                opacity: 0;
                transform: translateX(20px);
            `;
            document.body.appendChild(toast);

            // åŠ¨ç”»è¿›å…¥
            setTimeout(() => {
                toast.style.opacity = '1';
                toast.style.transform = 'translateX(0)';
            }, 10);

            // 3ç§’åæ¶ˆå¤±
            setTimeout(() => {
                toast.style.opacity = '0';
                toast.style.transform = 'translateX(20px)';
                setTimeout(() => {
                    document.body.removeChild(toast);
                }, 300);
            }, 3000);
        }

        // åŠ è½½é˜Ÿåˆ—ç»Ÿè®¡ä¿¡æ¯
        async function loadQueueStats() {
            try {
                const response = await fetch(`/api/queue/${encodeURIComponent(queueName)}/stats`);
                if (response.ok) {
                    queueStats = await response.json();
                    updateQueueInfo();
                }
            } catch (error) {
                console.error('Failed to load queue stats:', error);
            }
        }

        // åŠ è½½Workers
        async function loadWorkers() {
            try {
                // å¹¶è¡ŒåŠ è½½workersä¿¡æ¯å’Œæ±‡æ€»ç»Ÿè®¡
                const [workersResponse, summaryResponse] = await Promise.all([
                    fetch(`/api/queue/${encodeURIComponent(queueName)}/workers`),
                    fetch(`/api/queue/${encodeURIComponent(queueName)}/worker-summary`)
                ]);

                if (workersResponse.ok) {
                    const data = await workersResponse.json();
                    workers = data.workers || [];
                    console.log('Loaded workers:', workers);
                    renderWorkers();
                    updateQueueInfo();
                } else {
                    console.error('Workers API response not ok:', workersResponse.status);
                }

                if (summaryResponse.ok) {
                    const summaryData = await summaryResponse.json();
                    updateWorkerSummary(summaryData.summary);
                } else {
                    console.error('Worker summary API response not ok:', summaryResponse.status);
                }
            } catch (error) {
                console.error('Failed to load workers:', error);
                const container = document.getElementById('workersContainer');
                container.innerHTML = '<div class="empty-state" style="text-align: center; padding: 20px; color: #e74c3c;">åŠ è½½å¤±è´¥: ' + error.message + '</div>';
            }
        }

        // ä¿å­˜å®Œæ•´çš„æ±‡æ€»æ•°æ®
        let fullSummaryData = null;
        
        // æ›´æ–°Workeræ±‡æ€»ç»Ÿè®¡æ˜¾ç¤º
        function updateWorkerSummary(summary) {
            // ä¿å­˜å®Œæ•´æ•°æ®
            fullSummaryData = summary;
            
            if (showAllStats) {
                // æ˜¾ç¤ºåŒ…å«å†å²çš„å®Œæ•´ç»Ÿè®¡
                document.getElementById('totalSuccessCount').textContent = summary.total_success_count || 0;
                document.getElementById('totalFailedCount').textContent = summary.total_failed_count || 0;
                document.getElementById('totalTaskCount').textContent = summary.total_count || 0;
                document.getElementById('totalRunningTasks').textContent = summary.total_running_tasks || 0;
                
                // æ ¼å¼åŒ–å¹³å‡å¤„ç†æ—¶é—´
                const avgTime = summary.avg_processing_time || 0;
                let timeDisplay = '-';
                if (avgTime > 0) {
                    if (avgTime < 1) {
                        timeDisplay = `${Math.round(avgTime * 1000)}ms`;
                    } else if (avgTime < 60) {
                        timeDisplay = `${avgTime.toFixed(2)}s`;
                    } else {
                        const minutes = Math.floor(avgTime / 60);
                        const seconds = (avgTime % 60).toFixed(1);
                        timeDisplay = `${minutes}m${seconds}s`;
                    }
                }
                document.getElementById('avgProcessingTime').textContent = timeDisplay;
            } else {
                // ä»…æ˜¾ç¤ºåœ¨çº¿workerçš„ç»Ÿè®¡
                updateOnlineWorkersStats();
            }
        }
        
        // è®¡ç®—å¹¶æ˜¾ç¤ºä»…åœ¨çº¿workerçš„ç»Ÿè®¡
        function updateOnlineWorkersStats() {
            let onlineSuccess = 0;
            let onlineFailed = 0;
            let onlineTotal = 0;
            let onlineRunning = 0;
            let totalProcessingTime = 0;
            let processingTimeCount = 0;
            
            // è®¡ç®—åœ¨çº¿workerçš„ç»Ÿè®¡
            workers.forEach(worker => {
                if (worker.is_alive) {
                    onlineSuccess += worker.success_count || 0;
                    onlineFailed += worker.failed_count || 0;
                    onlineTotal += (worker.success_count || 0) + (worker.failed_count || 0);
                    onlineRunning += worker.running_tasks || 0;
                    
                    if (worker.avg_processing_time > 0) {
                        totalProcessingTime += worker.avg_processing_time;
                        processingTimeCount++;
                    }
                }
            });
            
            // æ›´æ–°æ˜¾ç¤º
            document.getElementById('totalSuccessCount').textContent = onlineSuccess;
            document.getElementById('totalFailedCount').textContent = onlineFailed;
            document.getElementById('totalTaskCount').textContent = onlineTotal;
            document.getElementById('totalRunningTasks').textContent = onlineRunning;
            
            // è®¡ç®—å¹³å‡å¤„ç†æ—¶é—´
            const avgTime = processingTimeCount > 0 ? totalProcessingTime / processingTimeCount : 0;
            let timeDisplay = '-';
            if (avgTime > 0) {
                if (avgTime < 1) {
                    timeDisplay = `${Math.round(avgTime * 1000)}ms`;
                } else if (avgTime < 60) {
                    timeDisplay = `${avgTime.toFixed(2)}s`;
                } else {
                    const minutes = Math.floor(avgTime / 60);
                    const seconds = (avgTime % 60).toFixed(1);
                    timeDisplay = `${minutes}m${seconds}s`;
                }
            }
            document.getElementById('avgProcessingTime').textContent = timeDisplay;
        }

        // åŠ è½½ä»»åŠ¡åˆ—è¡¨
        async function loadTasks(startTime = null, endTime = null, append = false) {
            if (isLoadingMore) return;

            const filter = document.getElementById('taskFilter').value;
            const statusFilter = document.getElementById('statusFilter').value;

            // æ„å»ºæŸ¥è¯¢å‚æ•°
            let queryParams = new URLSearchParams({
                limit: pageSize
            });

            if (startTime) {
                queryParams.append('start_time', startTime);
            }
            if (endTime) {
                queryParams.append('end_time', endTime);
            }

            try {
                if (!append) {
                    // æ˜¾ç¤ºåŠ è½½ä¸­çŠ¶æ€
                    document.getElementById('tasksBody').innerHTML =
                        '<tr><td colspan="8" class="loading">åŠ è½½ä¸­...</td></tr>';
                }

                isLoadingMore = true;
                const response = await fetch(
                    `/api/queue/${encodeURIComponent(queueName)}/tasks?${queryParams}`
                );

                if (response.ok) {
                    const data = await response.json();

                    // æ›´æ–°å¯¼èˆªçŠ¶æ€
                    oldestId = data.oldest_id;
                    newestId = data.newest_id;
                    hasMore = data.has_more;
                    noMoreData = data.tasks.length < pageSize;

                    if (!append) {
                        // æ–°æŸ¥è¯¢ï¼Œé‡ç½®æ•°æ®
                        currentStartTime = startTime;
                        currentEndTime = endTime;
                        allTasks = data.tasks;
                    } else {
                        // è¿½åŠ æ•°æ®ï¼Œå»é‡
                        const existingIds = new Set(allTasks.map(t => t.event_id));
                        const newTasks = data.tasks.filter(t => !existingIds.has(t.event_id));
                        allTasks = allTasks.concat(newTasks);

                        // æ£€æŸ¥æ˜¯å¦è¶…è¿‡1000æ¡é™åˆ¶
                        if (allTasks.length >= 1000) {
                            allTasks = allTasks.slice(0, 1000);
                            noMoreData = true;
                        }
                    }

                    // å®¢æˆ·ç«¯è¿‡æ»¤
                    let filteredTasks = allTasks;
                    if (filter || statusFilter) {
                        filteredTasks = allTasks.filter(task => {
                            const status = task.parsed_status || parseTaskStatus(task.status);
                            const matchesFilter = !filter ||
                                task.event_id.toLowerCase().includes(filter.toLowerCase()) ||
                                status.status.toLowerCase().includes(filter.toLowerCase());
                            const matchesStatus = !statusFilter || status.status === statusFilter;
                            return matchesFilter && matchesStatus;
                        });
                    }

                    renderTasks(filteredTasks);

                    // æ›´æ–°æ€»ä»»åŠ¡æ•°æ˜¾ç¤º - æ˜¾ç¤ºè¿‡æ»¤åçš„æ•°é‡å’Œé˜Ÿåˆ—æ€»æ•°
                    const totalCountDisplay = document.getElementById('totalTasks');
                    if (data.total_count !== undefined) {
                        if (filter || statusFilter) {
                            // æœ‰è¿‡æ»¤æ¡ä»¶æ—¶æ˜¾ç¤ºè¿‡æ»¤ç»“æœ/é˜Ÿåˆ—æ€»æ•°
                            totalCountDisplay.textContent = `${filteredTasks.length} / ${data.total_count}`;
                        } else {
                            // æ— è¿‡æ»¤æ¡ä»¶æ—¶æ˜¾ç¤ºå·²åŠ è½½/é˜Ÿåˆ—æ€»æ•°
                            totalCountDisplay.textContent = `${allTasks.length} / ${data.total_count}`;
                        }
                    } else {
                        totalCountDisplay.textContent = filteredTasks.length;
                    }
                }
            } catch (error) {
                console.error('Failed to load tasks:', error);
                if (!append) {
                    document.getElementById('tasksBody').innerHTML =
                        '<tr><td colspan="8" class="empty-state">åŠ è½½å¤±è´¥</td></tr>';
                }
            } finally {
                isLoadingMore = false;
            }
        }

        // åŠ è½½æ›´å¤šä»»åŠ¡
        async function loadMoreTasks() {
            if (!oldestId || noMoreData || isLoadingMore) return;

            // ä½¿ç”¨å½“å‰æœ€æ—©çš„IDä½œä¸ºæ–°çš„ç»“æŸæ—¶é—´
            const endTime = decrementStreamId(oldestId);
            await loadTasks(null, endTime, true);
        }

        // æ›´æ–°é˜Ÿåˆ—ä¿¡æ¯
        function updateQueueInfo() {
            // æ›´æ–°ä¾§è¾¹æ ä¿¡æ¯
            document.getElementById('sidebarQueueName').textContent = queueName;

            if (queueStats) {
                document.getElementById('sidebarQueueLength').textContent = queueStats.length || 0;
                document.getElementById('sidebarConsumerGroups').textContent =
                    queueStats.consumer_groups ? queueStats.consumer_groups.length : 0;
            }

            const aliveWorkers = workers.filter(w => w.is_alive);
            document.getElementById('sidebarOnlineWorkers').textContent = aliveWorkers.length;
            document.getElementById('sidebarTotalWorkers').textContent = workers.length;
        }

        // æ¸²æŸ“Workers
        function renderWorkers() {
            const container = document.getElementById('workersContainer');
            document.getElementById('workersLastUpdate').textContent = formatTime(new Date());

            // æ›´æ–°æ‘˜è¦ä¿¡æ¯
            const aliveWorkers = workers.filter(w => w.is_alive);
            document.getElementById('workersSummary').textContent = `${aliveWorkers.length}/${workers.length} åœ¨çº¿`;

            if (workers.length === 0) {
                container.innerHTML = '<div class="empty-state" style="text-align: center; padding: 20px; color: #999;">æš‚æ— Worker</div>';
                return;
            }

            // åˆ›å»ºè¡¨æ ¼
            try {
                container.innerHTML = `
                    <table class="workers-table">
                        <thead>
                            <tr>
                                <th style="width: 30px;">çŠ¶æ€</th>
                                <th>Worker ID</th>
                                <th>ä¸»æœºå</th>
                                <th>å¿ƒè·³</th>
                                <th>æ‰§è¡Œä¸­</th>
                                <th>å¹³å‡å¤„ç†æ—¶é—´</th>
                                <th>æˆåŠŸ</th>
                                <th>å¤±è´¥</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${workers
                        .sort((a, b) => {
                            // é¦–å…ˆæŒ‰çŠ¶æ€æ’åºï¼šåœ¨çº¿çš„åœ¨å‰
                            if (a.is_alive !== b.is_alive) {
                                return b.is_alive - a.is_alive;
                            }
                            // ç„¶åæŒ‰consumer_nameæ’åºï¼Œç¡®ä¿é¡ºåºç¨³å®š
                            const nameA = a.consumer_name || a.consumer_id || '';
                            const nameB = b.consumer_name || b.consumer_id || '';
                            return nameA.localeCompare(nameB);
                        })
                        .map(worker => {
                            // ä½¿ç”¨consumer_nameè€Œä¸æ˜¯consumer_idï¼Œè¿™æ ·ä¸ä»»åŠ¡åˆ—è¡¨ä¸­çš„æ¶ˆè´¹è€…åç§°ä¸€è‡´
                            const consumerName = worker.consumer_name || worker.consumer_id || '-';
                            const consumerId = worker.consumer_id || '-';
                            const hostname = worker.host || worker.hostname || '-';
                            const secondsAgo = worker.seconds_ago || 0;
                            const runningTasks = worker.running_tasks || 0;
                            const avgProcessingTime = worker.avg_processing_time || 0;
                            const successCount = worker.success_count || 0;
                            const failedCount = worker.failed_count || 0;

                            // æ ¼å¼åŒ–å¤„ç†æ—¶é—´æ˜¾ç¤º
                            let processingTimeDisplay = '-';
                            if (avgProcessingTime > 0) {
                                if (avgProcessingTime < 1) {
                                    processingTimeDisplay = `${Math.round(avgProcessingTime * 1000)}ms`;
                                } else if (avgProcessingTime < 60) {
                                    processingTimeDisplay = `${avgProcessingTime.toFixed(2)}s`;
                                } else {
                                    const minutes = Math.floor(avgProcessingTime / 60);
                                    const seconds = (avgProcessingTime % 60).toFixed(1);
                                    processingTimeDisplay = `${minutes}m${seconds}s`;
                                }
                            }

                            // è®¡ç®—æ˜¾ç¤ºå®½åº¦ï¼Œæ ¹æ®ä¾§è¾¹æ å®½åº¦åŠ¨æ€è°ƒæ•´
                            const sidebarWidth = parseInt(document.getElementById('sidebar').style.width) || 400;
                            const maxNameLength = Math.floor((sidebarWidth - 250) / 8); // ä¼°ç®—å¯æ˜¾ç¤ºå­—ç¬¦æ•°

                            return `
                                    <tr>
                                        <td style="text-align: center;">
                                            <span class="worker-status ${worker.is_alive ? 'alive' : 'dead'}" title="${worker.is_alive ? 'åœ¨çº¿' : 'ç¦»çº¿'}"></span>
                                        </td>
                                        <td style="font-weight: 600; font-size: 0.9em; position: relative; cursor: pointer;" 
                                            title="å®Œæ•´åç§°: ${consumerName}&#10;ID: ${consumerId}&#10;ç‚¹å‡»å¤åˆ¶"
                                            onclick="copyToClipboard('${consumerName}', event)">
                                            <span style="display: inline-block; max-width: calc(100% - 20px); overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">
                                                ${consumerName}
                                            </span>
                                            <span style="position: absolute; right: 5px; top: 50%; transform: translateY(-50%); font-size: 0.8em; color: #999;">ğŸ“‹</span>
                                        </td>
                                        <td title="${hostname}">
                                            ${hostname.length > 15 ? hostname.substring(0, 15) + '...' : hostname}
                                        </td>
                                        <td>${secondsAgo}ç§’å‰</td>
                                        <td style="color: #3498db; font-weight: bold;">${runningTasks}</td>
                                        <td style="color: #8e44ad;">${processingTimeDisplay}</td>
                                        <td style="color: #27ae60;">${successCount}</td>
                                        <td style="color: #e74c3c;">${failedCount}</td>
                                    </tr>
                                `;
                        }).join('')}
                        </tbody>
                    </table>
                `;
            } catch (error) {
                console.error('Error rendering workers table:', error);
                container.innerHTML = '<div class="empty-state" style="text-align: center; padding: 20px; color: #e74c3c;">æ¸²æŸ“å¤±è´¥: ' + error.message + '</div>';
            }
        }

        // æ¸²æŸ“ä»»åŠ¡åˆ—è¡¨
        function renderTasks(tasks) {
            const tbody = document.getElementById('tasksBody');

            if (tasks.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" class="empty-state">æš‚æ— ä»»åŠ¡</td></tr>';
                return;
            }

            let html = tasks.map(task => {
                const status = task.parsed_status || parseTaskStatus(task.status);

                // ä»streamæ•°æ®æˆ–çŠ¶æ€ä¸­è·å–æ—¶é—´ä¿¡æ¯
                let createdAt = status.created_at || status.timestamp;

                // å¦‚æœstatusä¸­æ²¡æœ‰æ—¶é—´ï¼Œå°è¯•ä»trigger_timeè·å–
                if (!createdAt && task.trigger_time) {
                    createdAt = new Date(task.trigger_time * 1000).toISOString();
                }

                // å¦‚æœstatusä¸­æ²¡æœ‰æ—¶é—´ï¼Œå°è¯•ä»streamæ•°æ®ä¸­è·å–
                if (!createdAt && task.stream_data) {
                    createdAt = task.stream_data.timestamp || task.stream_data.created_at;
                    if (!createdAt && task.stream_data.trigger_time) {
                        createdAt = new Date(task.stream_data.trigger_time * 1000).toISOString();
                    }
                }

                // å¦‚æœæ˜¯æ¶ˆæ¯IDæ ¼å¼ï¼ˆtimestamp-sequenceï¼‰ï¼Œæå–æ—¶é—´æˆ³
                if (!createdAt && task.message_id && task.message_id.includes('-')) {
                    const timestamp = parseInt(task.message_id.split('-')[0]);
                    if (!isNaN(timestamp)) {
                        createdAt = new Date(timestamp).toISOString();
                    }
                }

                // è·å–å‚æ•°å­—ç¬¦ä¸²
                const params = task.params_str || 'æ— å‚æ•°';
                const paramsDisplay = params.length > 50 ? params.substring(0, 50) + '...' : params;

                // è·å–æ¶ˆè´¹è€…åç§°
                const consumer = task.consumer || '-';

                // åˆ¤æ–­æ˜¯å¦å¯ä»¥è·å–ç»“æœï¼ˆåªæœ‰æˆåŠŸæˆ–å¤±è´¥çš„ä»»åŠ¡æ‰æœ‰ç»“æœï¼‰
                const canGetResult = status.status === 'success' || status.status === 'error' || status.status === 'failed';

                // è·å–å®Œæˆæ—¶é—´å’Œè€—æ—¶
                let completedAt = '-';
                let duration = '-';

                if (status.completed_at) {
                    completedAt = formatTime(new Date(status.completed_at * 1000).toISOString());
                }

                if (status.duration !== undefined) {
                    // æ ¼å¼åŒ–è€—æ—¶æ˜¾ç¤º
                    const dur = parseFloat(status.duration);
                    if (dur < 1) {
                        duration = `${(dur * 1000).toFixed(0)}ms`;
                    } else if (dur < 60) {
                        duration = `${dur.toFixed(2)}s`;
                    } else if (dur < 3600) {
                        const minutes = Math.floor(dur / 60);
                        const seconds = (dur % 60).toFixed(0);
                        duration = `${minutes}m ${seconds}s`;
                    } else {
                        const hours = Math.floor(dur / 3600);
                        const minutes = Math.floor((dur % 3600) / 60);
                        duration = `${hours}h ${minutes}m`;
                    }
                }

                return `
                    <tr>
                        <td><span class="task-id" title="${task.message_id || task.event_id}">${task.event_id}</span></td>
                        <td class="params-cell" onclick="showParamsDetail('${task.event_id}', \`${params.replace(/`/g, '\\`').replace(/\\/g, '\\\\')}\`)">
                            <span class="params-text">${paramsDisplay}</span>
                        </td>
                        <td>${consumer}</td>
                        <td><span class="status-badge ${getStatusClass(status.status)}">${status.status}</span></td>
                        <td>${formatTime(createdAt)}</td>
                        <td>${completedAt}</td>
                        <td>${duration}</td>
                        <td>
                            <button class="action-btn" onclick="getTaskResult('${task.event_id}')" ${canGetResult ? '' : 'disabled'}>
                                æŸ¥çœ‹ç»“æœ
                            </button>
                        </td>
                    </tr>
                `;
            }).join('');

            // æ·»åŠ åŠ è½½æ›´å¤šæç¤º
            if (allTasks.length >= 1000) {
                html += `
                    <tr>
                        <td colspan="8" class="limit-warning">
                            <strong>å·²è¾¾åˆ°æœ€å¤§æ˜¾ç¤ºé™åˆ¶ï¼ˆ1000æ¡ï¼‰</strong>
                            è¯·ä½¿ç”¨ç­›é€‰æ¡ä»¶ç¼©å°æŸ¥è¯¢èŒƒå›´ä»¥è·å¾—æ›´ç²¾ç¡®çš„ç»“æœ
                        </td>
                    </tr>
                `;
            } else if (!noMoreData && hasMore) {
                html += `
                    <tr id="loadMoreRow">
                        <td colspan="8" class="loading-more">
                            <div id="loadingIndicator" style="display: none;">åŠ è½½ä¸­...</div>
                            <div id="scrollHint">å‘ä¸‹æ»šåŠ¨åŠ è½½æ›´å¤š</div>
                        </td>
                    </tr>
                `;
            }

            tbody.innerHTML = html;
        }

        // åˆ·æ–°æ•°æ®
        function refreshData() {
            console.log('Refreshing data...');

            // æ›´æ–°æœ€ååˆ·æ–°æ—¶é—´
            lastRefreshTime = new Date();
            updateLastRefreshTime();

            // é‡ç½®æ— é™æ»šåŠ¨çŠ¶æ€
            allTasks = [];
            noMoreData = false;

            // é‡æ–°åŠ è½½æ‰€æœ‰æ•°æ®
            loadWorkers();
            loadQueueStats();
            loadTimeline();
            loadTasks(currentStartTime, currentEndTime);
        }

        // æ›´æ–°åˆ·æ–°é—´éš”
        function updateRefreshInterval() {
            const intervalSelect = document.getElementById('refreshInterval');
            const interval = parseInt(intervalSelect.value);

            // æ¸…é™¤ç°æœ‰çš„å®šæ—¶å™¨
            if (refreshIntervalId) {
                clearInterval(refreshIntervalId);
                refreshIntervalId = null;
            }

            // è®¾ç½®æ–°çš„å®šæ—¶å™¨
            if (interval > 0) {
                refreshIntervalId = setInterval(() => {
                    refreshData();
                }, interval * 1000);
                console.log(`Auto refresh enabled: every ${interval} seconds`);
            } else {
                console.log('Auto refresh disabled');
            }
        }

        // æ›´æ–°æœ€ååˆ·æ–°æ—¶é—´æ˜¾ç¤º
        function updateLastRefreshTime() {
            const element = document.getElementById('lastRefreshTime');

            // å¦‚æœå…ƒç´ ä¸å­˜åœ¨ï¼Œç›´æ¥è¿”å›ï¼ˆé¿å…æŠ¥é”™ï¼‰
            if (!element) {
                console.warn('lastRefreshTime element not found');
                return;
            }

            if (!lastRefreshTime) {
                element.textContent = '';
                return;
            }

            const updateDisplay = () => {
                // å†æ¬¡æ£€æŸ¥å…ƒç´ æ˜¯å¦å­˜åœ¨
                if (!element) return;

                const now = new Date();
                const diff = Math.floor((now - lastRefreshTime) / 1000);

                if (diff < 60) {
                    element.textContent = `æœ€ååˆ·æ–°: ${diff}ç§’å‰`;
                } else if (diff < 3600) {
                    const minutes = Math.floor(diff / 60);
                    element.textContent = `æœ€ååˆ·æ–°: ${minutes}åˆ†é’Ÿå‰`;
                } else {
                    element.textContent = `æœ€ååˆ·æ–°: ${formatTime(lastRefreshTime.toISOString())}`;
                }
            };

            updateDisplay();

            // æ¯ç§’æ›´æ–°ä¸€æ¬¡æ˜¾ç¤º
            if (element.updateTimer) {
                clearInterval(element.updateTimer);
            }
            element.updateTimer = setInterval(updateDisplay, 1000);
        }

        // ä»Redis Stream IDä¸­æå–æ—¶é—´æˆ³
        function extractTimeFromId(streamId) {
            if (!streamId || !streamId.includes('-')) return null;
            const timestamp = parseInt(streamId.split('-')[0]);
            return isNaN(timestamp) ? null : new Date(timestamp).toISOString();
        }

        // é€’å‡Stream IDï¼ˆè·å–å‰ä¸€ä¸ªå¯èƒ½çš„IDï¼‰
        function decrementStreamId(id) {
            const parts = id.split('-');
            const timestamp = parseInt(parts[0]);
            // è¿”å›æ¯”å½“å‰æ—¶é—´æˆ³æ—©1æ¯«ç§’çš„ID
            return `${timestamp - 1}-9999999`;
        }

        // åˆå§‹åŒ–æ— é™æ»šåŠ¨
        function initInfiniteScroll() {
            let scrollThrottle = null;
            const contentArea = document.querySelector('.content-area'); // è·å–å®é™…æ»šåŠ¨çš„å…ƒç´ 

            if (!contentArea) {
                console.error('Content area not found for infinite scroll');
                return;
            }

            contentArea.addEventListener('scroll', () => {
                if (scrollThrottle) return;

                scrollThrottle = setTimeout(() => {
                    scrollThrottle = null;

                    // æ£€æŸ¥æ˜¯å¦éœ€è¦åŠ è½½æ›´å¤š
                    const loadMoreRow = document.getElementById('loadMoreRow');
                    if (!loadMoreRow || isLoadingMore || noMoreData) return;

                    // æ£€æŸ¥æ˜¯å¦æ¥è¿‘åº•éƒ¨
                    const scrollTop = contentArea.scrollTop;
                    const scrollHeight = contentArea.scrollHeight;
                    const clientHeight = contentArea.clientHeight;

                    // å½“æ»šåŠ¨åˆ°è·ç¦»åº•éƒ¨100pxæ—¶è§¦å‘åŠ è½½
                    if (scrollTop + clientHeight >= scrollHeight - 100) {
                        // æ˜¾ç¤ºåŠ è½½ä¸­çŠ¶æ€
                        const loadingIndicator = document.getElementById('loadingIndicator');
                        const scrollHint = document.getElementById('scrollHint');
                        if (loadingIndicator) loadingIndicator.style.display = 'block';
                        if (scrollHint) scrollHint.style.display = 'none';

                        loadMoreTasks();
                    }
                }, 100);
            });
        }



        // æ ¹æ®é€‰æ‹©çš„æ—¶é—´èŒƒå›´åŠ è½½æ—¶é—´è½´
        async function loadTimelineForRange(startTime, endTime) {
            const durationMs = endTime - startTime;
            const durationStr = getOptimalDuration(durationMs);
            const interval = getTimelineInterval(durationStr);

            // è½¬æ¢ä¸ºRedis Stream IDæ ¼å¼
            const startId = `${Math.floor(startTime)}-0`;
            const endId = `${Math.floor(endTime)}-9999999`;

            try {
                const queryParams = new URLSearchParams({
                    duration: durationStr,
                    interval: interval,
                    start_time: startId,
                    end_time: endId
                });

                const response = await fetch(
                    `/api/queue/${encodeURIComponent(queueName)}/timeline?${queryParams}`
                );

                if (response.ok) {
                    const data = await response.json();
                    timelineData = data.timeline;
                    timelineStartTime = startTime;
                    timelineEndTime = endTime;
                    renderTimeline();

                    // åœ¨æ§åˆ¶å°æ˜¾ç¤ºæ—¶é—´è½´æ•°æ®ç»Ÿè®¡ï¼Œç”¨äºè°ƒè¯•
                    console.log(`Timeline loaded: ${data.total_tasks} total tasks, ${data.message_count} messages processed`);
                }
            } catch (error) {
                console.error('Failed to load timeline for range:', error);
            }
        }

        // æ ¹æ®æ¯«ç§’æ•°è·å–æœ€ä¼˜çš„æŒç»­æ—¶é—´å­—ç¬¦ä¸²
        function getOptimalDuration(durationMs) {
            const seconds = durationMs / 1000;
            const minutes = seconds / 60;
            const hours = minutes / 60;
            const days = hours / 24;

            if (days >= 1) {
                return Math.ceil(days) + 'd';
            } else if (hours >= 1) {
                return Math.ceil(hours) + 'h';
            } else if (minutes >= 1) {
                return Math.ceil(minutes) + 'm';
            } else {
                return Math.ceil(seconds) + 's';
            }
        }

        // åŠ è½½æ—¶é—´è½´æ•°æ®
        async function loadTimeline() {
            const duration = selectedTimeRange === 'custom' ? '24h' : selectedTimeRange;
            const interval = getTimelineInterval(duration);

            try {
                const response = await fetch(
                    `/api/queue/${encodeURIComponent(queueName)}/timeline?duration=${duration}&interval=${interval}`
                );

                if (response.ok) {
                    const data = await response.json();
                    timelineData = data.timeline;
                    timelineStartTime = data.start;
                    timelineEndTime = data.end;
                    renderTimeline();
                }
            } catch (error) {
                console.error('Failed to load timeline:', error);
            }
        }

        // æ ¹æ®æ—¶é—´èŒƒå›´è·å–åˆé€‚çš„æ—¶é—´é—´éš”
        function getTimelineInterval(duration) {
            // è§£ææŒç»­æ—¶é—´å­—ç¬¦ä¸²ä¸ºç§’æ•°
            const parseDuration = (dur) => {
                const match = dur.match(/^(\d+)([smhd])$/);
                if (!match) return 3600; // é»˜è®¤1å°æ—¶

                const value = parseInt(match[1]);
                const unit = match[2];

                switch (unit) {
                    case 's': return value;
                    case 'm': return value * 60;
                    case 'h': return value * 3600;
                    case 'd': return value * 86400;
                    default: return 3600;
                }
            };

            const durationSeconds = parseDuration(duration);

            // æ ¹æ®æŒç»­æ—¶é—´æ™ºèƒ½é€‰æ‹©é—´éš”ï¼Œç›®æ ‡æ˜¯æ˜¾ç¤º20-50ä¸ªæ•°æ®ç‚¹
            if (durationSeconds <= 60) {
                // 1åˆ†é’Ÿå†…ï¼šæ¯2ç§’
                return '2s';
            } else if (durationSeconds <= 300) {
                // 5åˆ†é’Ÿå†…ï¼šæ¯10ç§’
                return '10s';
            } else if (durationSeconds <= 900) {
                // 15åˆ†é’Ÿå†…ï¼šæ¯30ç§’
                return '30s';
            } else if (durationSeconds <= 1800) {
                // 30åˆ†é’Ÿå†…ï¼šæ¯1åˆ†é’Ÿ
                return '1m';
            } else if (durationSeconds <= 3600) {
                // 1å°æ—¶å†…ï¼šæ¯2åˆ†é’Ÿ
                return '2m';
            } else if (durationSeconds <= 7200) {
                // 2å°æ—¶å†…ï¼šæ¯5åˆ†é’Ÿ
                return '5m';
            } else if (durationSeconds <= 21600) {
                // 6å°æ—¶å†…ï¼šæ¯10åˆ†é’Ÿ
                return '10m';
            } else if (durationSeconds <= 43200) {
                // 12å°æ—¶å†…ï¼šæ¯30åˆ†é’Ÿ
                return '30m';
            } else if (durationSeconds <= 86400) {
                // 1å¤©å†…ï¼šæ¯1å°æ—¶
                return '1h';
            } else if (durationSeconds <= 259200) {
                // 3å¤©å†…ï¼šæ¯3å°æ—¶
                return '3h';
            } else if (durationSeconds <= 604800) {
                // 1å‘¨å†…ï¼šæ¯6å°æ—¶
                return '6h';
            } else if (durationSeconds <= 2592000) {
                // 1ä¸ªæœˆå†…ï¼šæ¯1å¤©
                return '1d';
            } else {
                // æ›´é•¿æ—¶é—´ï¼šæ¯7å¤©
                return '7d';
            }
        }

        // æ¸²æŸ“æ—¶é—´è½´
        function renderTimeline() {
            const chart = document.getElementById('timelineChart');
            const axis = document.getElementById('timelineAxis');

            if (!timelineData || timelineData.length === 0) {
                chart.innerHTML = '';
                axis.innerHTML = '';
                return;
            }

            // æ‰¾å‡ºæœ€å¤§å€¼ç”¨äºç¼©æ”¾
            const maxCount = Math.max(...timelineData.map(d => d.count), 1);

            // æ¸²æŸ“æŸ±çŠ¶å›¾
            chart.innerHTML = timelineData.map(data => {
                const height = (data.count / maxCount) * 100;
                return `<div class="timeline-bar" style="height: ${height}%" title="${data.count} ä»»åŠ¡"></div>`;
            }).join('');

            // æ¸²æŸ“æ—¶é—´è½´æ ‡ç­¾
            const labelCount = 5;
            const step = Math.floor(timelineData.length / labelCount);
            let labels = [];

            for (let i = 0; i < labelCount; i++) {
                const index = i * step;
                if (index < timelineData.length) {
                    const time = new Date(timelineData[index].timestamp);
                    labels.push(`<span>${formatShortTime(time)}</span>`);
                }
            }

            axis.innerHTML = labels.join('');
        }

        // æ ¼å¼åŒ–çŸ­æ—¶é—´æ˜¾ç¤º
        function formatShortTime(date) {
            const now = new Date();
            const diff = now - date;

            if (diff < 3600000) { // å°äº1å°æ—¶
                return date.toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit' });
            } else if (diff < 86400000) { // å°äº1å¤©
                return date.toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit' });
            } else {
                return date.toLocaleDateString('zh-CN', { month: '2-digit', day: '2-digit' });
            }
        }

        // åˆ‡æ¢æ—¶é—´èœå•
        function toggleTimeMenu() {
            const menu = document.getElementById('timeMenu');
            if (menu.style.display === 'none' || !menu.style.display) {
                menu.style.display = 'block';
                // ç‚¹å‡»å¤–éƒ¨å…³é—­èœå•
                setTimeout(() => {
                    document.addEventListener('click', closeTimeMenu);
                }, 100);
            } else {
                menu.style.display = 'none';
            }
        }

        // å…³é—­æ—¶é—´èœå•
        function closeTimeMenu(e) {
            const menu = document.getElementById('timeMenu');
            const timeDisplay = document.querySelector('.time-display');
            if (!menu.contains(e.target) && !timeDisplay.contains(e.target)) {
                menu.style.display = 'none';
                document.removeEventListener('click', closeTimeMenu);
            }
        }

        // é€‰æ‹©æ—¶é—´èŒƒå›´
        function selectTimeRange(range) {
            // æ›´æ–°æŒ‰é’®çŠ¶æ€
            document.querySelectorAll('.quick-select-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            if (event && event.target) {
                event.target.classList.add('active');
            }

            selectedTimeRange = range;

            // æ›´æ–°æ˜¾ç¤ºçš„æ—¶é—´èŒƒå›´
            const rangeMap = {
                '10m': 'æœ€è¿‘10åˆ†é’Ÿ',
                '30m': 'æœ€è¿‘30åˆ†é’Ÿ',
                '1h': 'æœ€è¿‘1å°æ—¶',
                '6h': 'æœ€è¿‘6å°æ—¶',
                '12h': 'æœ€è¿‘12å°æ—¶',
                '1d': 'æœ€è¿‘1å¤©',
                '7d': 'æœ€è¿‘7å¤©',
                'custom': 'è‡ªå®šä¹‰'
            };
            document.getElementById('currentTimeRange').textContent = rangeMap[range] || range;

            // è‡ªå®šä¹‰æ—¶é—´èŒƒå›´ä¸å…³é—­èœå•ï¼Œå…¶ä»–æ—¶é—´èŒƒå›´å…³é—­èœå•
            if (range !== 'custom') {
                document.getElementById('timeMenu').style.display = 'none';
            }

            if (range === 'custom') {
                // è®¾ç½®é»˜è®¤æ—¶é—´
                const now = new Date();
                const start = new Date(now.getTime() - 3600000); // 1å°æ—¶å‰
                document.getElementById('customEndTime').value = formatDateTimeLocal(now);
                document.getElementById('customStartTime').value = formatDateTimeLocal(start);
                return; // ä¸è‡ªåŠ¨åŠ è½½ï¼Œç­‰ç”¨æˆ·ç‚¹å‡»åº”ç”¨
            } else {

                // è®¡ç®—æ—¶é—´èŒƒå›´
                const now = Date.now();
                const duration = parse_time_duration_js(range);
                const start = now - duration * 1000;

                // è½¬æ¢ä¸ºRedis Stream IDæ ¼å¼
                const startId = `${start}-0`;
                const endId = '+';

                // æ›´æ–°æ˜¾ç¤º
                updateTimeRangeDisplay(new Date(start), new Date(now));

                // é‡ç½®æ— é™æ»šåŠ¨çŠ¶æ€
                allTasks = [];
                noMoreData = false;

                // åŒæ—¶åŠ è½½æ•°æ®å’Œæ—¶é—´è½´ï¼Œä½¿ç”¨ç›¸åŒçš„æ—¶é—´èŒƒå›´
                currentStartTime = startId;
                currentEndTime = endId;

                // åŒæ—¶å¯åŠ¨ä»»åŠ¡åˆ—è¡¨å’Œæ—¶é—´è½´åŠ è½½ï¼Œç¡®ä¿æ•°æ®ä¸€è‡´æ€§
                Promise.all([
                    loadTasks(startId, endId),
                    loadTimelineForRange(start, now)  // ä½¿ç”¨ç›¸åŒçš„æ—¶é—´èŒƒå›´
                ]);
            }
        }

        // JavaScriptç‰ˆæœ¬çš„æ—¶é—´è§£æ
        function parse_time_duration_js(duration) {
            const units = {
                's': 1,
                'm': 60,
                'h': 3600,
                'd': 86400
            };

            const match = duration.match(/^(\d+)([smhd])$/);
            if (match) {
                const value = parseInt(match[1]);
                const unit = match[2];
                return value * units[unit];
            }

            return parseInt(duration);
        }

        // æ ¼å¼åŒ–datetime-localè¾“å…¥
        function formatDateTimeLocal(date) {
            const pad = (n) => n.toString().padStart(2, '0');
            return `${date.getFullYear()}-${pad(date.getMonth() + 1)}-${pad(date.getDate())}T${pad(date.getHours())}:${pad(date.getMinutes())}`;
        }

        // åº”ç”¨è‡ªå®šä¹‰æ—¶é—´
        function applyCustomTime() {
            const startInput = document.getElementById('customStartTime').value;
            const endInput = document.getElementById('customEndTime').value;

            if (!startInput || !endInput) {
                alert('è¯·é€‰æ‹©å¼€å§‹å’Œç»“æŸæ—¶é—´');
                return;
            }

            const start = new Date(startInput);
            const end = new Date(endInput);

            if (start >= end) {
                alert('å¼€å§‹æ—¶é—´å¿…é¡»æ—©äºç»“æŸæ—¶é—´');
                return;
            }

            // è½¬æ¢ä¸ºRedis Stream IDæ ¼å¼
            const startId = `${start.getTime()}-0`;
            const endId = `${end.getTime()}-9999999`;

            updateTimeRangeDisplay(start, end);
            updateCustomTimeRangeDisplay(start, end);

            currentStartTime = startId;
            currentEndTime = endId;
            loadTasks(startId, endId);

            // å…³é—­æ—¶é—´èœå•
            document.getElementById('timeMenu').style.display = 'none';
        }

        // æ›´æ–°æ—¶é—´èŒƒå›´æ˜¾ç¤º
        function updateTimeRangeDisplay(start, end) {
            document.getElementById('selectedStartTime').textContent = formatTime(start.toISOString());
            document.getElementById('selectedEndTime').textContent = formatTime(end.toISOString());
        }

        // æ›´æ–°å³ä¸Šè§’çš„æ—¶é—´èŒƒå›´æ˜¾ç¤º
        function updateCustomTimeRangeDisplay(start, end) {
            const duration = end.getTime() - start.getTime();
            let rangeText = '';

            if (duration < 60 * 1000) {
                // å°äº1åˆ†é’Ÿï¼Œæ˜¾ç¤ºç§’æ•°
                const seconds = Math.round(duration / 1000);
                rangeText = `${seconds}ç§’`;
            } else if (duration < 60 * 60 * 1000) {
                // å°äº1å°æ—¶ï¼Œæ˜¾ç¤ºåˆ†é’Ÿæ•°
                const minutes = Math.round(duration / (60 * 1000));
                rangeText = `${minutes}åˆ†é’Ÿ`;
            } else if (duration < 24 * 60 * 60 * 1000) {
                // å°äº1å¤©ï¼Œæ˜¾ç¤ºå°æ—¶æ•°
                const hours = Math.round(duration / (60 * 60 * 1000) * 10) / 10;
                rangeText = `${hours}å°æ—¶`;
            } else {
                // æ˜¾ç¤ºå¤©æ•°
                const days = Math.round(duration / (24 * 60 * 60 * 1000) * 10) / 10;
                rangeText = `${days}å¤©`;
            }

            // æ˜¾ç¤ºä¸ºè‡ªå®šä¹‰èŒƒå›´
            const timeRange = `${start.toLocaleDateString('zh-CN', { month: '2-digit', day: '2-digit' })} ${start.toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit' })} - ${end.toLocaleDateString('zh-CN', { month: '2-digit', day: '2-digit' })} ${end.toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit' })} (${rangeText})`;

            document.getElementById('currentTimeRange').textContent = timeRange;
            document.getElementById('currentTimeRange').title = `å¼€å§‹: ${formatTime(start.toISOString())}\nç»“æŸ: ${formatTime(end.toISOString())}\næŒç»­æ—¶é—´: ${rangeText}`;

            // æ ‡è®°ä¸ºè‡ªå®šä¹‰èŒƒå›´
            selectedTimeRange = 'custom';
        }

        // åˆå§‹åŒ–æ—¶é—´è½´äº¤äº’
        function initTimelineInteraction() {
            const container = document.getElementById('timelineContainer');
            let startX = 0;
            let isSelecting = false;
            let startTime = 0;

            container.addEventListener('mousedown', (e) => {
                if (e.button !== 0) return; // åªå“åº”å·¦é”®

                e.preventDefault();
                e.stopPropagation();

                const rect = container.getBoundingClientRect();
                startX = e.clientX - rect.left;
                isSelecting = true;

                // è®¡ç®—å¯¹åº”çš„æ—¶é—´
                const ratio = startX / rect.width;
                startTime = timelineStartTime + (timelineEndTime - timelineStartTime) * ratio;

                const selection = document.getElementById('timelineSelection');
                selection.style.display = 'block';
                selection.style.left = startX + 'px';
                selection.style.width = '0px';

                // é˜²æ­¢æ–‡æœ¬é€‰æ‹©å’Œå…¶ä»–é»˜è®¤è¡Œä¸º
                document.body.style.userSelect = 'none';
                document.body.style.cursor = 'crosshair';
            });

            // ä½¿ç”¨documentçº§åˆ«çš„äº‹ä»¶ç›‘å¬å™¨ç¡®ä¿åœ¨å®¹å™¨å¤–ä¹Ÿèƒ½å“åº”
            document.addEventListener('mousemove', (e) => {
                if (!isSelecting) return;

                e.preventDefault();
                e.stopPropagation();

                const rect = container.getBoundingClientRect();
                let currentX = e.clientX - rect.left;

                // é™åˆ¶åœ¨å®¹å™¨èŒƒå›´å†…
                currentX = Math.max(0, Math.min(rect.width, currentX));

                const width = currentX - startX;
                const selection = document.getElementById('timelineSelection');

                if (width > 0) {
                    selection.style.left = startX + 'px';
                    selection.style.width = width + 'px';
                } else {
                    selection.style.left = currentX + 'px';
                    selection.style.width = Math.abs(width) + 'px';
                }
            });

            document.addEventListener('mouseup', (e) => {
                if (!isSelecting) return;

                e.preventDefault();
                e.stopPropagation();

                isSelecting = false;

                // æ¢å¤é»˜è®¤æ ·å¼
                document.body.style.userSelect = '';
                document.body.style.cursor = '';

                const rect = container.getBoundingClientRect();
                let endX = e.clientX - rect.left;
                endX = Math.max(0, Math.min(rect.width, endX));

                if (Math.abs(endX - startX) < 5) {
                    // ç‚¹å‡»è€Œéæ‹–æ‹½
                    document.getElementById('timelineSelection').style.display = 'none';
                    return;
                }

                // è®¡ç®—é€‰ä¸­çš„æ—¶é—´èŒƒå›´
                const startRatio = Math.min(startX, endX) / rect.width;
                const endRatio = Math.max(startX, endX) / rect.width;

                const selectedStart = timelineStartTime + (timelineEndTime - timelineStartTime) * startRatio;
                const selectedEnd = timelineStartTime + (timelineEndTime - timelineStartTime) * endRatio;

                // åº”ç”¨é€‰ä¸­çš„æ—¶é—´èŒƒå›´
                const startId = `${Math.floor(selectedStart)}-0`;
                const endId = `${Math.floor(selectedEnd)}-9999999`;

                const startDate = new Date(selectedStart);
                const endDate = new Date(selectedEnd);

                updateTimeRangeDisplay(startDate, endDate);
                updateCustomTimeRangeDisplay(startDate, endDate);

                currentStartTime = startId;
                currentEndTime = endId;

                // æ ¹æ®é€‰æ‹©çš„æ—¶é—´èŒƒå›´é‡æ–°åŠ è½½æ—¶é—´è½´å’Œä»»åŠ¡
                loadTimelineForRange(selectedStart, selectedEnd);
                loadTasks(startId, endId);

                // éšè—é€‰æ‹©æ¡†
                setTimeout(() => {
                    document.getElementById('timelineSelection').style.display = 'none';
                }, 200);
            });

            // å¤„ç†é¼ æ ‡ç¦»å¼€
            container.addEventListener('mouseleave', () => {
                if (isSelecting) {
                    isSelecting = false;
                    document.getElementById('timelineSelection').style.display = 'none';
                }
            });
        }

        // åˆå§‹åŒ–ä¾§è¾¹æ æ‹–æ‹½
        function initSidebarResize() {
            const sidebar = document.getElementById('sidebar');
            const resizer = document.getElementById('sidebarResizer');
            let isResizing = false;
            let startX = 0;
            let startWidth = 0;

            // ä»localStorageæ¢å¤å®½åº¦
            const savedWidth = localStorage.getItem('sidebarWidth');
            if (savedWidth) {
                sidebar.style.width = savedWidth + 'px';
            }

            resizer.addEventListener('mousedown', (e) => {
                isResizing = true;
                startX = e.clientX;
                startWidth = sidebar.offsetWidth;
                resizer.classList.add('resizing');
                document.body.style.cursor = 'col-resize';
                document.body.style.userSelect = 'none';
                e.preventDefault();
            });

            document.addEventListener('mousemove', (e) => {
                if (!isResizing) return;

                const deltaX = e.clientX - startX;
                const newWidth = Math.max(300, Math.min(800, startWidth + deltaX));
                sidebar.style.width = newWidth + 'px';
            });

            document.addEventListener('mouseup', () => {
                if (!isResizing) return;

                isResizing = false;
                resizer.classList.remove('resizing');
                document.body.style.cursor = '';
                document.body.style.userSelect = '';

                // ä¿å­˜å®½åº¦åˆ°localStorage
                localStorage.setItem('sidebarWidth', sidebar.offsetWidth);
            });
        }

        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', () => {
            if (!queueName) {
                window.location.href = '/';
                return;
            }

            // åˆå§‹åŒ–ä¾§è¾¹æ æ‹–æ‹½
            initSidebarResize();
            
            // åˆå§‹åŒ–ç»Ÿè®¡æ¨¡å¼æŒ‰é’®æ ·å¼
            const allStatsBtn = document.getElementById('allStatsBtn');
            const onlineStatsBtn = document.getElementById('onlineStatsBtn');
            
            if (!showAllStats) {
                // å¦‚æœç”¨æˆ·ä¸Šæ¬¡é€‰æ‹©çš„æ˜¯"ä»…åœ¨çº¿"
                onlineStatsBtn.style.background = '#3498db';
                onlineStatsBtn.style.color = 'white';
                allStatsBtn.style.background = 'white';
                allStatsBtn.style.color = '#3498db';
                allStatsBtn.style.borderRight = '1px solid #3498db';
            }

            // ç»‘å®šäº‹ä»¶
            document.getElementById('taskFilter').addEventListener('input', () => {
                // é‡æ–°åŠ è½½å½“å‰æ—¶é—´èŒƒå›´çš„æ•°æ®
                loadTasks(currentStartTime, currentEndTime);
            });

            document.getElementById('statusFilter').addEventListener('change', () => {
                // é‡æ–°åŠ è½½å½“å‰æ—¶é—´èŒƒå›´çš„æ•°æ®
                loadTasks(currentStartTime, currentEndTime);
            });
            
            // ç»‘å®šç»Ÿè®¡æ¨¡å¼æŒ‰é’® (allStatsBtn å’Œ onlineStatsBtn å·²ç»åœ¨ä¸Šé¢åˆå§‹åŒ–äº†)
            
            // æ‰€æœ‰è®°å½•æŒ‰é’®
            allStatsBtn.addEventListener('click', () => {
                if (!showAllStats) {
                    showAllStats = true;
                    localStorage.setItem('statsMode', 'all'); // ä¿å­˜ç”¨æˆ·é€‰æ‹©
                    
                    // æ›´æ–°æŒ‰é’®æ ·å¼
                    allStatsBtn.style.background = '#3498db';
                    allStatsBtn.style.color = 'white';
                    allStatsBtn.style.borderRight = 'none';
                    onlineStatsBtn.style.background = 'white';
                    onlineStatsBtn.style.color = '#3498db';
                    
                    // æ›´æ–°ç»Ÿè®¡æ˜¾ç¤º
                    if (fullSummaryData) {
                        updateWorkerSummary(fullSummaryData);
                    }
                }
            });
            
            // ä»…åœ¨çº¿æŒ‰é’®
            onlineStatsBtn.addEventListener('click', () => {
                if (showAllStats) {
                    showAllStats = false;
                    localStorage.setItem('statsMode', 'online'); // ä¿å­˜ç”¨æˆ·é€‰æ‹©
                    
                    // æ›´æ–°æŒ‰é’®æ ·å¼
                    onlineStatsBtn.style.background = '#3498db';
                    onlineStatsBtn.style.color = 'white';
                    allStatsBtn.style.background = 'white';
                    allStatsBtn.style.color = '#3498db';
                    allStatsBtn.style.borderRight = '1px solid #3498db';
                    
                    // æ›´æ–°ç»Ÿè®¡æ˜¾ç¤º
                    if (fullSummaryData) {
                        updateWorkerSummary(fullSummaryData);
                    }
                }
            });

            // åˆå§‹åŒ–æ—¶é—´è½´äº¤äº’
            initTimelineInteraction();

            // åˆå§‹åŒ–æ— é™æ»šåŠ¨
            initInfiniteScroll();

            // åŠ è½½æ•°æ®
            loadQueueStats();
            loadWorkers();

            // é»˜è®¤é€‰æ‹©æœ€è¿‘1å°æ—¶
            document.querySelector('.quick-select-btn[onclick*="1h"]').click();

            // é»˜è®¤å¼€å¯æ¯30ç§’è‡ªåŠ¨åˆ·æ–°
            updateRefreshInterval();
        });

        // æ˜¾ç¤ºå‚æ•°è¯¦æƒ…
        function showParamsDetail(eventId, params) {
            const modal = document.getElementById('paramsModal');
            const content = document.getElementById('paramsContent');

            document.getElementById('paramsTaskId').textContent = eventId;
            content.textContent = params;
            modal.style.display = 'block';
        }

        // å…³é—­å‚æ•°æ¨¡æ€æ¡†
        function closeParamsModal() {
            document.getElementById('paramsModal').style.display = 'none';
        }
        
        // æ˜¾ç¤ºWorkerå†å²è®°å½•
        async function showWorkerHistory() {
            const modal = document.getElementById('workerHistoryModal');
            const content = document.getElementById('workerHistoryContent');
            modal.style.display = 'flex';
            
            try {
                // è·å–è¯¥é˜Ÿåˆ—çš„workerå†å²è®°å½•
                const response = await fetch(`/api/queue/${encodeURIComponent(queueName)}/workers/offline-history?limit=50`);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                const history = data.history || [];
                
                if (history.length === 0) {
                    content.innerHTML = '<div class="empty-state" style="text-align: center; padding: 40px; color: #999;">æš‚æ— ä¸‹çº¿è®°å½•</div>';
                    return;
                }
                
                // åˆ›å»ºè¡¨æ ¼æ˜¾ç¤ºå†å²è®°å½•
                content.innerHTML = `
                    <table class="workers-table" style="width: 100%;">
                        <thead>
                            <tr>
                                <th>Worker ID</th>
                                <th>ä¸»æœºå</th>
                                <th>PID</th>
                                <th>ä¸Šçº¿æ—¶é—´</th>
                                <th>ä¸‹çº¿æ—¶é—´</th>
                                <th>è¿è¡Œæ—¶é•¿</th>
                                <th>æˆåŠŸ</th>
                                <th>å¤±è´¥</th>
                                <th>æ€»è®¡</th>
                                <th>å¹³å‡è€—æ—¶</th>
                                <th>ä¸‹çº¿åŸå› </th>
                            </tr>
                        </thead>
                        <tbody>
                            ${history.map(record => `
                                <tr>
                                    <td title="${record.consumer_id}">${record.consumer_id.substring(0, 16)}...</td>
                                    <td>${record.host}</td>
                                    <td>${record.pid}</td>
                                    <td>${formatTime(record.online_time_str)}</td>
                                    <td>${formatTime(record.offline_time_str)}</td>
                                    <td>${record.duration_str || '-'}</td>
                                    <td class="success">${record.total_success_count || 0}</td>
                                    <td class="error">${record.total_failed_count || 0}</td>
                                    <td>${record.total_count || 0}</td>
                                    <td>${record.avg_processing_time ? record.avg_processing_time.toFixed(3) + 's' : '-'}</td>
                                    <td><span class="status-badge ${record.shutdown_reason === 'heartbeat_timeout' ? 'error' : 'warning'}">${record.shutdown_reason}</span></td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                    <div style="text-align: center; padding: 20px; color: #666;">
                        æ˜¾ç¤ºæœ€è¿‘ ${history.length} æ¡è®°å½• | 
                        <a href="/api/queue/${encodeURIComponent(queueName)}/workers/offline-history?limit=1000" target="_blank">å¯¼å‡ºå…¨éƒ¨</a>
                    </div>
                `;
            } catch (error) {
                console.error('Failed to load worker history:', error);
                content.innerHTML = `<div class="empty-state" style="text-align: center; padding: 40px; color: #e74c3c;">åŠ è½½å¤±è´¥: ${error.message}</div>`;
            }
        }
        
        // å…³é—­Workerå†å²è®°å½•æ¨¡æ€æ¡†
        function closeWorkerHistoryModal() {
            document.getElementById('workerHistoryModal').style.display = 'none';
        }

        // è·å–ä»»åŠ¡ç»“æœ
        async function getTaskResult(eventId) {
            try {
                const response = await fetch(`/api/task/${encodeURIComponent(eventId)}/result`);
                const data = await response.json();

                if (data.result) {
                    // æœ‰ç»“æœï¼Œæ˜¾ç¤ºæ¨¡æ€æ¡†
                    const modal = document.getElementById('resultModal');
                    const content = document.getElementById('resultContent');
                    content.textContent = data.result;
                    modal.classList.add('show');
                } else {
                    // æ— ç»“æœï¼Œæ˜¾ç¤ºæç¤ºæ¶ˆæ¯
                    showNotification('è¯¥ä»»åŠ¡æš‚æ— ç»“æœ', 'info');
                }
            } catch (error) {
                showNotification('è·å–ç»“æœå¤±è´¥: ' + error.message, 'error');
            }
        }

        // å…³é—­ç»“æœæ¨¡æ€æ¡†
        function closeResultModal() {
            document.getElementById('resultModal').classList.remove('show');
        }

    </script>

    <!-- ç»“æœæ¨¡æ€æ¡† -->
    <div class="result-modal" id="resultModal" onclick="if(event.target === this) closeResultModal()">
        <div class="modal-content">
            <div class="modal-header">
                <h3>ä»»åŠ¡ç»“æœ</h3>
                <button class="modal-close" onclick="closeResultModal()">&times;</button>
            </div>
            <div class="result-content" id="resultContent">
                åŠ è½½ä¸­...
            </div>
        </div>
    </div>

    <!-- å‚æ•°è¯¦æƒ…æ¨¡æ€æ¡† -->
    <div class="params-modal" id="paramsModal" onclick="if(event.target === this) closeParamsModal()">
        <div class="params-modal-content">
            <div class="params-modal-header">
                <h3>ä»»åŠ¡å‚æ•° - <span id="paramsTaskId"></span></h3>
                <span class="params-close" onclick="closeParamsModal()">&times;</span>
            </div>
            <pre id="paramsContent" style="white-space: pre-wrap; word-break: break-word;"></pre>
        </div>
    </div>
    
    <!-- Workerå†å²è®°å½•æ¨¡æ€æ¡† -->
    <div class="params-modal" id="workerHistoryModal" onclick="if(event.target === this) closeWorkerHistoryModal()">
        <div class="params-modal-content" style="max-width: 900px;">
            <div class="params-modal-header">
                <h3>Worker ä¸‹çº¿å†å²è®°å½•</h3>
                <span class="params-close" onclick="closeWorkerHistoryModal()">&times;</span>
            </div>
            <div id="workerHistoryContent" style="max-height: 600px; overflow-y: auto;">
                <div class="loading" style="padding: 20px; text-align: center;">åŠ è½½ä¸­...</div>
            </div>
        </div>
    </div>
</body>

</html>