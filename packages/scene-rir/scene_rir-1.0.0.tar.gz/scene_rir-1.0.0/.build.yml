image: debian/stable
packages:
  - python3
  - python3-pip
  - python3-venv
  - curl  # Ensure curl is available for Miniconda installation
secrets:
  - d1a5878e-cce3-4a6a-98cd-466533df1aab  # PyPI
  - 0afb9704-4bd6-45b4-a039-1ee2fea4acdf  # Anaconda
environment:
  attempts: 3
  sleep_time: 5
shell: true
tasks:
  - tagged-build: |  
        set -xe
        cd scene_rir
        echo "Checking if current commit is tagged..."
        if ! git describe --exact-match --tags HEAD > /dev/null 2>&1; then
            echo "This commit is not tagged. Skipping build."
            exit 1
        fi
  - setup_for_pypi:  |
        set -xe
        cd scene_rir
        python3 -m venv venv
        source venv/bin/activate
        pip install --upgrade pip 
        pip install build twine
  - build_for_pypi:  |
        set -xe
        cd scene_rir
        source venv/bin/activate
        python3 -m build
  - upload_to_pypi: |
        set -xe
        cd scene_rir
        source venv/bin/activate
        set +x  # Disable echo for secret use
        export TWINE_PASSWORD=$(cat ~/.ssh/d1a5878e-cce3-4a6a-98cd-466533df1aab)
        twine upload -u __token__ -p "$TWINE_PASSWORD" dist/*
        set -x
  - setup_for_anaconda: |  
        set -xe
        MINICONDA=Miniconda3-latest-Linux-x86_64.sh
        curl -fsSL -o "$MINICONDA" https://repo.anaconda.com/miniconda/$MINICONDA
        bash $MINICONDA -b -p "$HOME/miniconda"
        export PATH="$HOME/miniconda/bin:$PATH"
        conda config --set always_yes yes --set changeps1 no
        conda update -q conda
        conda install -y conda-build anaconda-client
        conda install -y -c conda-forge grayskull
  - build_for_anaconda: |  
        set -xe
        export PATH="$HOME/miniconda/bin:$PATH"
        grayskull pypi scene-rir
        # Wait for the package to be available on PyPI
        for i in $(seq 1 $attempts); do
            if conda build scene-rir; then
                break
            else
                echo "Attempt $i failed. Retrying in $sleep_time seconds..."
                sleep $sleep_time
            fi
        done
  - upload_to_anaconda: |
        set -xe
        export PATH="$HOME/miniconda/bin:$PATH"
        set +x  # Disable echo for secret use
        export ANACONDA_TOKEN=$(cat ~/.ssh/0afb9704-4bd6-45b4-a039-1ee2fea4acdf)
        anaconda --token "$ANACONDA_TOKEN" upload --user csevast ~/miniconda/conda-bld/noarch/*.conda --skip-existing      
        set -x  
