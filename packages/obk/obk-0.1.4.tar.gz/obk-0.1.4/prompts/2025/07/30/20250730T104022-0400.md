<?xml version="1.0" encoding="UTF-8"?>
<gsl-prompt id="20250730T104022-0400">
<gsl-description>

<!--
Standardized GSL prompt and spec for OBK/Codex agent work.
- Fill in all sections as needed.
- Rules for agent/maintainer updates are in the Document Specification section.
- Agents may only update workflows and add new tests (see rules).
- Everything else is for maintainers.
-->
</gsl-description>
<gsl-header>

# Add Dependency Injection to Project

</gsl-header>
<gsl-block>

<gsl-purpose>

## 1. Purpose

Implement dependency injection in the Python project using the `dependency-injector` library to improve modularity, testability, and maintainability. Refactor core services to use containers and providers, enabling scalable architecture and easier testing.

</gsl-purpose>

<gsl-inputs>

## 2. Inputs

| Input                                         | Notes                                                        |
|-----------------------------------------------|--------------------------------------------------------------|
| dependency-injector (PyPI package)            | Main DI framework for Python                                 |
| "How to Set Up Dependency Injection in Python with `dependency-injector`" | Article describing steps and best practices                  |
| Existing project source code                  | Project to be refactored                                     |
| pytest (or test framework used in project)    | To validate DI wiring and mock swapping                      |

</gsl-inputs>

<gsl-outputs>

## 3. Outputs

* **Declared** `dependency-injector` as a dependency in `pyproject.toml` to enable DI capabilities.
    
* **Documented** the new container-based architecture in `README.md`, with instructions pointing users to `src/obk/containers.py` for details.
    
* **Added** an application container providing `Greeter` and `Divider` services for injection.
    
* **Moved** service classes into a standalone module (`services.py`) for cleaner injection and reuse.
    
* **Refactored** `ObkCLI` to resolve services from the container and support service overrides in tests.
    

- ##### Testing
        
    * âœ… `pytest -q`
        
</gsl-outputs>

<gsl-workflows>

## 4. Workflows

<!-- List main steps or processes required for the task. -->
- Install `dependency-injector`.
- Move services to their own module.
- Create `Container` for dependency wiring.
- Refactor CLI to resolve dependencies from the container.
- Update documentation and tests.

</gsl-workflows>

<gsl-tdd>
<gsl-description>

## 5. Tests
</gsl-description>
<gsl-test id="T1">

* T1: CLI greets user using the service injected by the container

  ```sh
  # Run: python -m obk hello-world
  # Expected: "hello world"
  ```

</gsl-test>
<gsl-test id="T2">

* T2: CLI divider returns the result of dividing a by b

  ```sh
  # Run: python -m obk divide 6 2
  # Expected: "3.0"
  ```

</gsl-test>

<gsl-test id="T3">

* T3: Division by zero returns error message and exit code 2

  ```sh
  # Run: python -m obk divide 1 0
  # Expected: stderr includes "[ERROR] cannot divide by zero"; exit code 2
  ```

</gsl-test>

<gsl-test id="T4">

* T4: CLI supports custom log file path injection

  ```sh
  # Run: python -m obk divide 4 2 --logfile=my.log
  # Expected: "2.0" and my.log contains "Divide 4.0 by 2.0 = 2.0"
  ```

</gsl-test>

<gsl-test id="T5">

* T5: Greeter can be overridden via DI container

  ```python
  from obk.containers import Container
  class MockGreeter:
      def hello(self):
          return "hi from mock"
  container = Container()
  container.greeter.override(MockGreeter())
  from obk.cli import ObkCLI
  ObkCLI(container=container).run(["hello-world"])
  # Expected: "hi from mock"
  ```

</gsl-test>

<gsl-test id="T6">

* T6: Divider can be overridden via DI container

  ```python
  class MockDivider:
      def divide(self, a, b):
          return 42
  container.divider.override(MockDivider())
  ObkCLI(container=container).run(["divide", "1", "3"])
  # Expected: "42"
  ```

</gsl-test>

<gsl-test id="T7">

* T7: Fatal command exits with code 1 and outputs fatal message

  ```sh
  # Run: python -m obk fail
  # Expected: exit code 1, stderr includes "fatal"
  ```

</gsl-test>


</gsl-tdd>

<gsl-document-spec>

## 6. Document Specification

#### Overview

This section defines the rules and conventions for maintaining and updating this prompt document.
This specification applies only to this prompt document.

#### S-1. Identifier and Numbering

Major sections and tests in this document must use a clear, hierarchical ID. Use an uppercase prefix and numbers, like `T1`, `T2.1`, or `S1.2.3`:

* Use `T` for tests in `<gsl-tdd>` (e.g., `T1`, `T2.1`).
* Use `S` for specification items if needed (e.g., `S1`, `S2.1`).
* Number all items in order, with no gaps or repeats.
* Do not remove or change IDs except to fix errors.

These IDs are required for referencing, tracking, and audits.

#### S-2. Update Policy

These rules apply to automated changes by agents. Manual edits by maintainers can update any section.

* Agents **may only** update these sections:

  * `<gsl-workflows>` (agents may add, change, or remove any part)
  * `<gsl-tdd>` (agents may add new `<gsl-test>` elements, but may not change or remove any existing `<gsl-test>`)
* Agents **must not** change or remove any other content in this document.

These rules protect the integrity of the document and its tests, while allowing agents to add workflows and new tests.

#### S-3. Tests Section

* `<gsl-tdd>` holds one or more `<gsl-test>` elements.
* Each `<gsl-test>` must start with a single-line description and have a unique `id` (e.g., `T1`, `T2`, etc).
* You may add a code block (with triple backticks) below the test description if needed.
* Agents may only add new `<gsl-test>` elements. They must not change or remove any existing test.
* Only maintainers can change or remove tests.
* Use these tests for auditing and validation.

</gsl-document-spec>
</gsl-block>
</gsl-prompt>


