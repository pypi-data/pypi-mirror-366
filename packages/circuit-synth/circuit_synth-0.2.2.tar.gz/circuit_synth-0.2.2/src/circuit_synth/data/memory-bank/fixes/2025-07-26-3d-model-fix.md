# KiCad 3D Model Fix - 2025-07-26

## Issue
Generated KiCad PCB files were missing 3D model information, resulting in no 3D visualization of components. Reference PCB files had proper 3D models but generated ones were missing the `(model ...)` sections entirely.

## Root Cause Analysis
1. **FootprintLibraryCache**: The `_extract_basic_info()` method wasn't extracting 3D model paths during indexing
2. **PCBBoard**: The `_create_footprint_from_library_data()` method wasn't populating footprint 3D model fields
3. **PCBParser**: The `_parse_footprint()` method had incomplete 3D model parsing (missing offset, scale, rotate)

## Solution Implemented

### 1. Enhanced FootprintLibraryCache (`src/circuit_synth/kicad_api/pcb/footprint_library.py`)
- **Increased read buffer**: Changed from 4KB to 8KB to capture 3D models at end of files
- **Added 3D model extraction**: Parse `(model "path/to/model.wrl")` patterns
- **Updated serialization**: Added `models_3d` field to JSON cache format
- **Added debug logging**: Track 3D model extraction during indexing

```python
# Extract 3D models
models_3d = []
model_pos = 0
while True:
    model_start = content.find('(model "', model_pos)
    if model_start == -1:
        break
    model_end = content.find('"', model_start + 8)
    if model_end == -1:
        break
    model_path = content[model_start + 8:model_end]
    models_3d.append(model_path)
    model_pos = model_end
info.models_3d = models_3d
```

### 2. Enhanced PCBBoard (`src/circuit_synth/kicad_api/pcb/pcb_board.py`)
- **Added 3D model parsing**: Extract model info from library data in `_create_footprint_from_library_data()`
- **Implemented `_parse_library_model()`**: Parse model path, offset, scale, and rotation values
- **Populated footprint fields**: Set `model_path`, `model_offset`, `model_scale`, `model_rotate`

```python
# Extract 3D model information
if 'model' in library_data:
    for model_data in library_data['model']:
        model_info = self._parse_library_model(model_data)
        if model_info:
            footprint.model_path = model_info['path']
            footprint.model_offset = model_info.get('offset', (0.0, 0.0, 0.0))
            footprint.model_scale = model_info.get('scale', (1.0, 1.0, 1.0))
            footprint.model_rotate = model_info.get('rotate', (0.0, 0.0, 0.0))
            break  # Use first model for now
```

### 3. Fixed PCBParser (`src/circuit_synth/kicad_api/pcb/pcb_parser.py`)
- **Enhanced 3D model parsing**: Complete parsing of offset, scale, rotate parameters
- **Added error handling**: Graceful handling of malformed 3D model data
- **Added debug logging**: Track 3D model parsing success

```python
# Parse offset, scale, rotate if present
offset_elem = self._find_element(model_elem, "offset")
if offset_elem:
    xyz_elem = self._find_element(offset_elem, "xyz")
    if xyz_elem and len(xyz_elem) >= 4:
        try:
            footprint.model_offset = (float(xyz_elem[1]), float(xyz_elem[2]), float(xyz_elem[3]))
        except (ValueError, IndexError):
            logger.debug(f"Failed to parse model offset: {xyz_elem}")
```

## Results
✅ **Before Fix**: Generated PCB files had no 3D models
```
(footprint "Resistor_SMD:R_0603_1608Metric"
    (layer "F.Cu")
    (uuid "...")
    ...
    (embedded_fonts no)
)
```

✅ **After Fix**: Generated PCB files include proper 3D models
```
(footprint "Resistor_SMD:R_0603_1608Metric"
    (layer "F.Cu")
    (uuid "...")
    ...
    (model "${KICAD9_3DMODEL_DIR}/Resistor_SMD.3dshapes/R_0603_1608Metric.wrl"
        (offset (xyz 0 0 0))
        (scale (xyz 1 1 1))
        (rotate (xyz 0 0 0))
    )
    (embedded_fonts no)
)
```

## Components Now With 3D Models
- **R1, R2**: `${KICAD9_3DMODEL_DIR}/Resistor_SMD.3dshapes/R_0603_1608Metric.wrl`
- **C1**: `${KICAD9_3DMODEL_DIR}/Capacitor_SMD.3dshapes/C_0603_1608Metric.wrl`

## Verification
- Cleared footprint cache to force rebuild with 3D model extraction
- Regenerated reference design PCB
- Verified 3D models present in output file using `grep -A 10 -B 5 "model.*wrl"`
- Confirmed proper offset, scale, and rotation values

## Impact
- **3D Visualization**: KiCad 3D viewer now shows components properly
- **Design Review**: Better visual feedback for PCB design validation  
- **Manufacturing**: More accurate 3D previews for assembly planning
- **Documentation**: Enhanced visual documentation capabilities

## Files Modified
- `src/circuit_synth/kicad_api/pcb/footprint_library.py`
- `src/circuit_synth/kicad_api/pcb/pcb_board.py` 
- `src/circuit_synth/kicad_api/pcb/pcb_parser.py`

## Technical Notes
- 3D model paths use KiCad environment variables (e.g., `${KICAD9_3DMODEL_DIR}`)
- Default values: offset=(0,0,0), scale=(1,1,1), rotate=(0,0,0)
- Only first 3D model is used if multiple models exist in footprint
- Footprint cache automatically rebuilds when libraries are newer than index