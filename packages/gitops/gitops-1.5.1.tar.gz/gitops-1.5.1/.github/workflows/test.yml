name: Test
on:
  push:
    branches:
      - develop
  pull_request: ~

permissions:
  actions: read # Read the metrics
  contents: write # to be able to publish a GitHub release
  issues: write # to be able to comment on released issues
  pull-requests: write # to be able to comment on released pull requests
  id-token: write # to enable use of OIDC for npm provenance / AWS

jobs:
  ci:
    uses: uptick/actions/.github/workflows/ci.yaml@main
    secrets: inherit
    with:
      praise-on-fix: false
      python-version: 3.12
      mise: true
      mise-install: true
      command: |
        mise run install
        mise run ci
  build:
    name: Build and Push Docker Image
    uses: uptick/actions/.github/workflows/ci.yaml@main
    secrets:
      SECRET_ENV: "${{ secrets.CLUSTER_KEY }}"
    #https://github.com/uptick/actions/blob/main/.github/workflows/ci.yaml
    with:
      aws-iam-role-arn: "arn:aws:iam::610829907584:role/default-github-actions-ci-role"
      docker-enabled: true
      docker-context: "."
      docker-prefix: test
      docker-tag-latest: false
      docker-repository: "610829907584.dkr.ecr.ap-southeast-2.amazonaws.com/gitops"
      command: echo $SECRET_ENV | base64 -d > cluster.key
