env:
  DOCKER_BUILDKIT: 1

steps:
  - label: ":rocket: vLLM Integration Tests"
    key: "test"
    timeout_in_minutes: 60
    commands:
      - chmod +x .buildkite/scripts/vllm-integration-tests.sh
      - .buildkite/scripts/vllm-integration-tests.sh --hf-token=$HF_TOKEN --server-wait-timeout=240
  
  - label: ":broom: Cleanup Docker"
    key: "clean"
    depends_on: ["test"]
    allow_dependency_failure: true
    commands: |
      chmod +x .buildkite/scripts/docker-cleanup.sh
      .buildkite/scripts/docker-cleanup.sh

  - label: "Clean up"
    depends_on:
        - "clean"
    command: |
      export TARGET="$PWD"
      echo "Deleting current workspace $TARGET"
      cd /
      sudo rm -rf "$TARGET"